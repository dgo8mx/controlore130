<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Unidad de Aprovechamientos y Restauracion Forestal - SEMARNAT Durango</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --gob-green: #13322B;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .bg-institucional { background: linear-gradient(135deg, var(--gob-green) 0%, #1a4838 100%); }
        .status-dot {
            width: 12px; height: 12px; border-radius: 50%; display: inline-block;
            box-shadow: 0 0 0 3px rgba(255,255,255,0.2);
        }
        @keyframes fade-in { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-fade-in { animation: fade-in 0.3s ease-out; }
        .animate-pulse-dot { animation: pulse-dot 2s ease-in-out infinite; }
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        .card-shadow:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        .btn-action { transition: all 0.2s ease; }
        .btn-action:hover { transform: scale(1.1); }
        .badge {
            padding: 0.25rem 0.75rem; border-radius: 9999px;
            font-size: 0.75rem; font-weight: 600;
            display: inline-flex; align-items: center; gap: 0.25rem;
        }
        .modal {
            display: none; position: fixed; z-index: 50;
            left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            background-color: white; margin: 5% auto; padding: 0;
            border-radius: 1rem; max-width: 800px; max-height: 85vh;
            overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        .stat-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
            border-left: 4px solid var(--success);
            padding: 1.5rem; border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .input-modern {
            transition: all 0.2s ease;
            border: 2px solid #e2e8f0;
        }
        .input-modern:focus {
            border-color: var(--success);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
            outline: none;
        }
        .table-row-hover:hover {
            background-color: #f0fdf4;
            transition: all 0.2s ease;
        }
        .row-synced {
            background-color: #dbeafe !important;
            border-left: 3px solid #3b82f6;
        }
        .row-local {
            background-color: #fef3c7 !important;
            border-left: 3px solid #f59e0b;
        }
        @media print {
            .no-print { display: none !important; }
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .folio-preview {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            font-family: 'Courier New', monospace;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .pagination-controls {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        .pagination-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s;
            border: 2px solid #e2e8f0;
        }
        .pagination-btn:hover:not(:disabled) {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
        }
        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .pagination-btn.active {
            background-color: #10b981;
            color: white;
            border-color: #10b981;
        }
        .page-info {
            padding: 0.5rem 1rem;
            background-color: #f1f5f9;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
        }
        .filter-section {
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }
        .year-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            margin: 0.25rem;
            background: #e0f2fe;
            color: #0369a1;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .year-badge:hover {
            background: #0369a1;
            color: white;
        }
        .year-badge.active {
            background: #10b981;
            color: white;
        }
    </style>
</head>
<body class="bg-slate-50">

    <header class="bg-institucional text-white p-4 shadow-2xl border-b-4 border-[#9D2449] no-print">
        <div class="container mx-auto">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div class="flex items-center gap-4">
                    <span class="text-4xl">üå≤</span>
                    <div>
                        <h1 class="text-xl font-bold tracking-tight">Unidad de Aprovechamientos y Recursos Forestales</h1>
                        <p class="text-xs text-emerald-200">Control de Determinantes 2026</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="dot" class="status-dot bg-gray-400"></span>
                            <span id="status-text" class="text-[10px] uppercase font-bold">Verificando...</span>
                        </div>
                    </div>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="cargarTodosLosRegistros()" 
                            class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg text-xs font-bold shadow-lg transition">
                        <i class="fas fa-cloud-download-alt"></i> CARGAR TODO
                    </button>
                    <button onclick="sincronizarConNube()" 
                            class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-lg text-xs font-bold shadow-lg transition">
                        <i class="fas fa-cloud-upload-alt"></i> SINCRONIZAR
                    </button>
                    <button onclick="exportarCSV()" 
                            class="bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg text-xs font-bold shadow-lg transition">
                        <i class="fas fa-file-csv"></i> EXPORTAR
                    </button>
                    <button onclick="limpiarCache()" 
                            class="bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg text-xs font-bold shadow-lg transition">
                        <i class="fas fa-broom"></i> LIMPIAR CACHE
                    </button>
                    <button onclick="probarConexion()" 
                            class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-lg text-xs font-bold shadow-lg transition">
                        <i class="fas fa-plug"></i> PROBAR
                    </button>
                </div>
            </div>
        </div>
    </header>

    <section class="container mx-auto px-6 py-4 no-print">
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <div class="stat-card">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-slate-500 font-semibold uppercase">Total</p>
                        <h3 id="stat-total" class="text-2xl font-bold text-slate-800">0</h3>
                    </div>
                    <div class="bg-emerald-100 p-3 rounded-lg">
                        <i class="fas fa-file-alt text-xl text-emerald-600"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card" style="border-left-color: #3b82f6;">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-slate-500 font-semibold uppercase">Nube</p>
                        <h3 id="stat-nube" class="text-2xl font-bold text-slate-800">0</h3>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-lg">
                        <i class="fas fa-cloud text-xl text-blue-600"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card" style="border-left-color: #f59e0b;">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-slate-500 font-semibold uppercase">Pendientes</p>
                        <h3 id="stat-pendientes" class="text-2xl font-bold text-slate-800">0</h3>
                    </div>
                    <div class="bg-amber-100 p-3 rounded-lg">
                        <i class="fas fa-clock text-xl text-amber-600"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card" style="border-left-color: #8b5cf6;">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-slate-500 font-semibold uppercase">Esta Semana</p>
                        <h3 id="stat-semana" class="text-2xl font-bold text-slate-800">0</h3>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-lg">
                        <i class="fas fa-calendar-week text-xl text-purple-600"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card" style="border-left-color: #06b6d4;">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-slate-500 font-semibold uppercase">Este Mes</p>
                        <h3 id="stat-mes" class="text-2xl font-bold text-slate-800">0</h3>
                    </div>
                    <div class="bg-cyan-100 p-3 rounded-lg">
                        <i class="fas fa-calendar text-xl text-cyan-600"></i>
                    </div>
                </div>
            </div>
            <div class="stat-card" style="border-left-color: #ec4899;">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-xs text-slate-500 font-semibold uppercase">Este A√±o</p>
                        <h3 id="stat-anio" class="text-2xl font-bold text-slate-800">0</h3>
                    </div>
                    <div class="bg-pink-100 p-3 rounded-lg">
                        <i class="fas fa-calendar-check text-xl text-pink-600"></i>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <main class="container mx-auto px-6 py-4 grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div class="lg:col-span-2 space-y-6">
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden card-shadow">
                <div class="bg-gradient-to-r from-emerald-600 to-emerald-700 text-white p-6">
                    <div class="flex items-center gap-3">
                        <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                            <i class="fas fa-file-signature text-2xl"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold">Registrar Nuevo Determinante</h2>
                            <p class="text-xs text-emerald-100 mt-1">Complete los campos requeridos</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 space-y-4">
                    <!-- Preview del pr√≥ximo folio -->
                    <div id="folio-preview" class="folio-preview">
                        <div class="text-xs opacity-75 mb-1">PR√ìXIMO FOLIO</div>
                        <div id="folio-text">Cargando...</div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-2 uppercase tracking-wide">
                                <i class="fas fa-folder text-emerald-600 mr-1"></i> Tr√°mite
                            </label>
                            <select id="sel-tramite" class="input-modern w-full p-3 rounded-lg text-sm font-medium">
                                <option value="">-- Seleccione --</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-700 mb-2 uppercase tracking-wide">
                                <i class="fas fa-hashtag text-emerald-600 mr-1"></i> Bit√°cora Referencia
                            </label>
                            <input type="text" id="txt-bitacora" placeholder="Ej: 2026-001-VO" 
                                   class="input-modern w-full p-3 rounded-lg text-sm">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-2 uppercase tracking-wide">
                            <i class="fas fa-align-left text-emerald-600 mr-1"></i> Asunto del Determinante *
                        </label>
                        <textarea id="txt-asunto" rows="3" maxlength="500" placeholder="Describa el asunto del determinante (m√≠nimo 10 caracteres)" 
                                  class="input-modern w-full p-3 rounded-lg text-sm resize-none"></textarea>
                        <div class="flex justify-end mt-1">
                            <span id="char-count" class="text-[10px] text-slate-500 font-bold">0/500</span>
                        </div>
                    </div>
                    
                    <div class="flex justify-end gap-2 pt-2">
                        <button onclick="limpiarFormulario()" 
                                class="px-6 py-3 bg-slate-200 hover:bg-slate-300 text-slate-700 rounded-lg font-bold text-sm transition">
                            <i class="fas fa-eraser mr-2"></i> Limpiar
                        </button>
                        <button onclick="registrarLocal()" 
                                class="px-6 py-3 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg font-bold text-sm shadow-lg transition">
                            <i class="fas fa-save mr-2"></i> Guardar Registro
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg overflow-hidden card-shadow">
                <div class="bg-gradient-to-r from-slate-700 to-slate-800 text-white p-6">
                    <div class="flex items-center justify-between flex-wrap gap-4">
                        <div class="flex items-center gap-3">
                            <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                                <i class="fas fa-table text-2xl"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold">Historial de Determinantes</h2>
                                <p class="text-xs text-slate-300 mt-1" id="subtitle-registros">Todos los registros</p>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="imprimirTabla()" 
                                    class="px-4 py-2 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-lg text-xs font-bold transition">
                                <i class="fas fa-print"></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="p-6">
                    <!-- Filtros -->
                    <div class="filter-section">
                        <div class="mb-3">
                            <label class="block text-xs font-bold text-slate-700 mb-2">
                                <i class="fas fa-filter mr-1"></i> FILTRAR POR A√ëO
                            </label>
                            <div id="year-filters" class="flex flex-wrap gap-2"></div>
                        </div>
                        <div class="filter-grid">
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-2">
                                    <i class="fas fa-search mr-1"></i> BUSCAR
                                </label>
                                <input type="text" id="search-input" placeholder="Buscar en registros..." 
                                       onkeyup="aplicarFiltros()"
                                       class="input-modern w-full p-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-2">
                                    <i class="fas fa-folder mr-1"></i> TR√ÅMITE
                                </label>
                                <select id="filter-tramite" onchange="aplicarFiltros()" 
                                        class="input-modern w-full p-2 rounded-lg text-sm">
                                    <option value="">Todos</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-2">
                                    <i class="fas fa-sort mr-1"></i> ORDENAR
                                </label>
                                <select id="sort-order" onchange="aplicarFiltros()" 
                                        class="input-modern w-full p-2 rounded-lg text-sm">
                                    <option value="desc">M√°s recientes primero</option>
                                    <option value="asc">M√°s antiguos primero</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-700 mb-2">
                                    <i class="fas fa-list mr-1"></i> MOSTRAR
                                </label>
                                <select id="items-per-page" onchange="cambiarItemsPorPagina()" 
                                        class="input-modern w-full p-2 rounded-lg text-sm">
                                    <option value="25">25 por p√°gina</option>
                                    <option value="50">50 por p√°gina</option>
                                    <option value="100">100 por p√°gina</option>
                                    <option value="250">250 por p√°gina</option>
                                    <option value="all">Todos</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="bg-slate-100 border-b-2 border-slate-300">
                                    <th class="p-4 text-left font-bold text-slate-700 uppercase text-xs">
                                        Determinante / Detalles
                                    </th>
                                    <th class="p-4 text-center font-bold text-slate-700 uppercase text-xs">
                                        Estado
                                    </th>
                                    <th class="p-4 text-center font-bold text-slate-700 uppercase text-xs">
                                        Acciones
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <tr>
                                    <td colspan="3" class="p-12 text-center text-slate-400">
                                        <i class="fas fa-inbox text-5xl mb-3 opacity-50"></i>
                                        <p class="font-semibold">No hay registros</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Controles de paginaci√≥n -->
                    <div id="pagination-controls" class="pagination-controls" style="display: none;">
                        <button onclick="irAPagina(1)" class="pagination-btn">
                            <i class="fas fa-angle-double-left"></i>
                        </button>
                        <button onclick="cambiarPagina(-1)" class="pagination-btn">
                            <i class="fas fa-angle-left"></i> Anterior
                        </button>
                        <span class="page-info">
                            P√°gina <span id="current-page">1</span> de <span id="total-pages">1</span>
                        </span>
                        <button onclick="cambiarPagina(1)" class="pagination-btn">
                            Siguiente <i class="fas fa-angle-right"></i>
                        </button>
                        <button onclick="irAPaginaFinal()" class="pagination-btn">
                            <i class="fas fa-angle-double-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-6">
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden card-shadow">
                <div class="bg-gradient-to-r from-purple-600 to-purple-700 text-white p-6">
                    <div class="flex items-center gap-3">
                        <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                            <i class="fas fa-list text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold">Cat√°logo de Tr√°mites</h3>
                            <p class="text-xs text-purple-200 mt-1">Gesti√≥n de homoclaves</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-2">
                            <i class="fas fa-tag mr-1"></i> Homoclave
                        </label>
                        <input type="text" id="new-hc" placeholder="Ej: SEMARNAT-01-001" 
                               class="input-modern w-full p-2 rounded-lg text-sm">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold text-slate-700 mb-2">
                            <i class="fas fa-file-text mr-1"></i> Nombre del Tr√°mite
                        </label>
                        <input type="text" id="new-name" placeholder="Nombre completo" 
                               class="input-modern w-full p-2 rounded-lg text-sm">
                    </div>
                    
                    <button onclick="agregarCatalogo()" 
                            class="w-full bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg font-bold text-sm shadow-lg transition">
                        <i class="fas fa-plus mr-2"></i> Agregar al Cat√°logo
                    </button>
                    
                    <div class="border-t pt-4">
                        <h4 class="text-xs font-bold text-slate-600 mb-3 uppercase tracking-wide">
                            Tr√°mites Registrados (<span id="count-tramites">0</span>)
                        </h4>
                        <div id="catalogo-list" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-xs text-slate-500 italic text-center py-2">Sin tr√°mites</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-2xl shadow-lg overflow-hidden card-shadow">
                <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6">
                    <div class="flex items-center gap-3">
                        <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                            <i class="fas fa-info-circle text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold">Informaci√≥n del Sistema</h3>
                            <p class="text-xs text-blue-200 mt-1">Estado y configuraci√≥n</p>
                        </div>
                    </div>
                </div>
                
                <div class="p-6 space-y-3 text-xs">
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                        <span class="font-semibold text-slate-600">
                            <i class="fas fa-map-marker-alt text-emerald-600 mr-2"></i>√Årea
                        </span>
                        <span class="font-bold text-slate-800">AR</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                        <span class="font-semibold text-slate-600">
                            <i class="fas fa-database text-emerald-600 mr-2"></i>Registros en Memoria
                        </span>
                        <span id="memory-count" class="font-mono text-slate-700">0</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                        <span class="font-semibold text-slate-600">
                            <i class="fas fa-calendar-alt text-emerald-600 mr-2"></i>√öltima Sincronizaci√≥n
                        </span>
                        <span id="last-sync" class="font-mono text-slate-700">--</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                        <span class="font-semibold text-slate-600">
                            <i class="fas fa-calendar-alt text-emerald-600 mr-2"></i>√öltima Actualizaci√≥n
                        </span>
                        <span id="last-update" class="font-mono text-slate-700">--</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-slate-50 rounded-lg">
                        <span class="font-semibold text-slate-600">
                            <i class="fas fa-shield-alt text-emerald-600 mr-2"></i>Versi√≥n
                        </span>
                        <span class="font-mono text-slate-700">3.0.0</span>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="modal-view" class="modal">
        <div class="modal-content">
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 text-white p-6 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                        <i class="fas fa-file-invoice text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold">Detalle del Determinante</h3>
                </div>
                <button onclick="cerrarModal('modal-view')" 
                        class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modal-view-content" class="p-6"></div>
        </div>
    </div>

    <script>
        const AREA_SIGLAS = "AR";
        const AREA_NOMBRE = "Unidad de Aprovechamientos y Restauracion Forestal";
        const SB_URL = "https://rnwksmgwmnjatrgezaaa.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJud2tzbWd3bW5qYXRyZ2V6YWFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MTY1MTYsImV4cCI6MjA4MzQ5MjUxNn0.vQXfHnWRuCNOjbqX-iYragObPA9GyCw9z9RMsNLjEfE";
        
        let _sb = null;
        let conectado = false;
        let ultimoConsecutivoNube = 0;
        
        // Variables para manejo de datos
        let todosLosRegistros = []; // Todos los registros en memoria
        let registrosFiltrados = []; // Registros despu√©s de aplicar filtros
        let registrosPendientes = []; // Solo registros pendientes de sincronizar
        
        // Variables de paginaci√≥n
        let paginaActual = 1;
        let itemsPorPagina = 25;
        let filtroAnio = 'todos';
        
        const LS_CATALOGO = `cat_${AREA_SIGLAS}`;
        const LS_PENDIENTES = `pend_${AREA_SIGLAS}`;
        const LS_ULTIMA_SYNC = `sync_${AREA_SIGLAS}`;
        const LS_ULTIMO_CONSECUTIVO = `cons_${AREA_SIGLAS}`;
        
        window.onload = async function() {
            console.log("=== INICIALIZANDO √ÅREA: " + AREA_SIGLAS + " ===");
            
            if (typeof supabase === 'undefined') {
                console.error("‚úó Supabase no cargado");
                mostrarAlerta('error', 'Error: Librer√≠a no disponible');
                return;
            }
            
            try {
                const { createClient } = supabase;
                _sb = createClient(SB_URL, SB_KEY);
                console.log("‚úì Cliente Supabase creado");
            } catch(e) {
                console.error("‚úó Error al crear cliente:", e);
                mostrarAlerta('error', 'Error de inicializaci√≥n: ' + e.message);
            }
            
            inicializarStorage();
            cargarPendientesLocal();
            configurarContador();
            
            await verificarConexion();
            
            if (conectado) {
                await cargarUltimoConsecutivoNube();
                await cargarTodosLosRegistros();
                await cargarCatalogoDesdeNube();
            }
            
            renderizarTodo();
            actualizarVistaProximoFolio();
            actualizarFecha();
            actualizarUltimaSincronizacion();
            console.log("‚úì Sistema inicializado");
        };
        
        function inicializarStorage() {
            try {
                if (!localStorage.getItem(LS_CATALOGO)) {
                    localStorage.setItem(LS_CATALOGO, JSON.stringify([]));
                }
                if (!localStorage.getItem(LS_PENDIENTES)) {
                    localStorage.setItem(LS_PENDIENTES, JSON.stringify([]));
                }
                console.log("‚úì Storage inicializado");
            } catch(e) {
                console.error("‚úó Error al inicializar storage:", e);
            }
        }
        
        function cargarPendientesLocal() {
            try {
                const data = localStorage.getItem(LS_PENDIENTES);
                registrosPendientes = data ? JSON.parse(data) : [];
                console.log(`‚úì ${registrosPendientes.length} registros pendientes cargados`);
            } catch(e) {
                console.error("Error al cargar pendientes:", e);
                registrosPendientes = [];
            }
        }
        
        function guardarPendientesLocal() {
            try {
                localStorage.setItem(LS_PENDIENTES, JSON.stringify(registrosPendientes));
                return true;
            } catch(e) {
                console.error("Error al guardar pendientes:", e);
                mostrarAlerta('error', 'Error al guardar pendientes localmente');
                return false;
            }
        }
        
        async function cargarTodosLosRegistros() {
            if (!conectado) {
                mostrarAlerta('error', 'No hay conexi√≥n a la base de datos');
                return;
            }
            
            mostrarCargando(true, 'Cargando todos los registros...');
            
            try {
                let todosLosDatos = [];
                let desde = 0;
                const limite = 1000;
                let hayMas = true;
                
                while (hayMas) {
                    const { data, error, count } = await _sb
                        .from('registro_oficios')
                        .select('*', { count: 'exact' })
                        .eq('area_siglas', AREA_SIGLAS)
                        .order('fecha', { ascending: false })
                        .range(desde, desde + limite - 1);
                    
                    if (error) throw error;
                    
                    if (data && data.length > 0) {
                        todosLosDatos = todosLosDatos.concat(data);
                        desde += limite;
                        
                        // Actualizar progreso
                        const progreso = Math.min(100, Math.round((todosLosDatos.length / (count || todosLosDatos.length)) * 100));
                        mostrarCargando(true, `Cargando registros... ${todosLosDatos.length} de ${count || '?'} (${progreso}%)`);
                        
                        console.log(`Cargados ${todosLosDatos.length} registros...`);
                    }
                    
                    hayMas = data && data.length === limite;
                }
                
                // Marcar todos como sincronizados y de la nube
                todosLosRegistros = todosLosDatos.map(reg => ({
                    ...reg,
                    sincronizado: true,
                    bloqueado: true,
                    origen: 'nube'
                }));
                
                // Agregar registros pendientes locales
                registrosPendientes.forEach(regLocal => {
                    const existe = todosLosRegistros.some(r => r.determinante === regLocal.determinante);
                    if (!existe) {
                        todosLosRegistros.push(regLocal);
                    }
                });
                
                console.log(`‚úì Total de ${todosLosRegistros.length} registros cargados (${todosLosDatos.length} de nube, ${registrosPendientes.length} pendientes)`);
                
                aplicarFiltros();
                actualizarEstadisticas();
                actualizarFiltrosAnio();
                actualizarFiltroTramites();
                mostrarAlerta('success', `${todosLosRegistros.length} registros cargados exitosamente`);
                
            } catch (error) {
                console.error("Error al cargar registros:", error);
                mostrarAlerta('error', 'Error al cargar registros: ' + error.message);
            } finally {
                mostrarCargando(false);
            }
        }
        
        async function cargarUltimoConsecutivoNube() {
            if (!conectado) {
                cargarUltimoConsecutivoLocal();
                return;
            }
            
            try {
                const anio = new Date().getFullYear();
                
                const { data, error } = await _sb
                    .from('registro_oficios')
                    .select('consecutivo')
                    .eq('area_siglas', AREA_SIGLAS)
                    .eq('anio', anio)
                    .order('consecutivo', { ascending: false })
                    .limit(1)
                    .maybeSingle();
                
                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                
                if (data) {
                    ultimoConsecutivoNube = data.consecutivo;
                    console.log(`‚úì √öltimo consecutivo en nube: ${ultimoConsecutivoNube}`);
                    localStorage.setItem(LS_ULTIMO_CONSECUTIVO, ultimoConsecutivoNube.toString());
                } else {
                    ultimoConsecutivoNube = 0;
                    console.log("‚úì No hay registros previos en nube para este a√±o");
                }
            } catch (e) {
                console.error("‚úó Error al cargar consecutivo:", e);
                cargarUltimoConsecutivoLocal();
            }
        }
        
        function cargarUltimoConsecutivoLocal() {
            try {
                const guardado = localStorage.getItem(LS_ULTIMO_CONSECUTIVO);
                ultimoConsecutivoNube = guardado ? parseInt(guardado) : 0;
                console.log(`‚ö† Usando consecutivo local: ${ultimoConsecutivoNube}`);
            } catch(e) {
                ultimoConsecutivoNube = 0;
            }
        }
        
        function obtenerProximoConsecutivo() {
            const anio = new Date().getFullYear();
            
            // Obtener m√°ximo de registros en memoria del a√±o actual
            const regsDelAnio = todosLosRegistros.filter(r => r.anio === anio);
            const maxConsecutivoMemoria = regsDelAnio.length > 0 
                ? Math.max(...regsDelAnio.map(r => r.consecutivo))
                : 0;
            
            const maxConsecutivo = Math.max(ultimoConsecutivoNube, maxConsecutivoMemoria);
            
            return maxConsecutivo + 1;
        }
        
        function actualizarVistaProximoFolio() {
            const proximoConsecutivo = obtenerProximoConsecutivo();
            const anio = new Date().getFullYear();
            const proximoFolio = `OR-130/${AREA_SIGLAS}/${String(proximoConsecutivo).padStart(4, '0')}/${anio}`;
            
            const folioElement = document.getElementById('folio-text');
            if (folioElement) {
                folioElement.textContent = proximoFolio;
            }
        }
        
        function configurarContador() {
            const textarea = document.getElementById('txt-asunto');
            const counter = document.getElementById('char-count');
            textarea.addEventListener('input', function() {
                const len = this.value.length;
                counter.textContent = len + '/500';
                counter.className = len > 500 ? 'text-[10px] text-red-600 font-bold' :
                                   len > 450 ? 'text-[10px] text-amber-600 font-bold' :
                                   'text-[10px] text-slate-500 font-bold';
            });
        }
        
        async function probarConexion() {
            const dot = document.getElementById('dot');
            const text = document.getElementById('status-text');
            dot.className = "status-dot bg-blue-500";
            text.textContent = "Probando...";
            mostrarAlerta('info', 'Probando conexi√≥n...');
            
            if (!_sb) {
                mostrarAlerta('error', 'Cliente no inicializado');
                dot.className = "status-dot bg-red-500";
                text.textContent = "Error";
                return;
            }
            
            try {
                const { data, error } = await _sb
                    .from('registro_oficios')
                    .select('id')
                    .limit(1);
                
                if (error) throw error;
                
                conectado = true;
                dot.className = "status-dot bg-emerald-500 animate-pulse-dot";
                text.textContent = "Conectado";
                mostrarAlerta('success', 'Conexi√≥n exitosa');
                console.log("‚úì Conexi√≥n OK");
                
                await cargarUltimoConsecutivoNube();
                actualizarVistaProximoFolio();
            } catch (e) {
                conectado = false;
                dot.className = "status-dot bg-red-500";
                text.textContent = "Sin conexi√≥n";
                mostrarAlerta('error', 'Error: ' + e.message);
                console.error("‚úó Error:", e);
            }
        }
        
        async function verificarConexion() {
            const dot = document.getElementById('dot');
            const text = document.getElementById('status-text');
            
            if (!_sb) {
                conectado = false;
                dot.className = "status-dot bg-red-500";
                text.textContent = "Sin Cliente";
                return;
            }
            
            try {
                const { error } = await _sb
                    .from('registro_oficios')
                    .select('id')
                    .limit(1);
                
                if (!error) {
                    conectado = true;
                    dot.className = "status-dot bg-emerald-500 animate-pulse-dot";
                    text.textContent = "Conectado";
                } else {
                    conectado = false;
                    dot.className = "status-dot bg-amber-500";
                    text.textContent = "Modo Local";
                }
            } catch (e) {
                conectado = false;
                dot.className = "status-dot bg-red-500";
                text.textContent = "Sin Conexi√≥n";
            }
        }
        
        function obtenerCatalogo() {
            try {
                const data = localStorage.getItem(LS_CATALOGO);
                return data ? JSON.parse(data) : [];
            } catch(e) {
                console.error("Error al leer cat√°logo:", e);
                return [];
            }
        }
        
        function guardarCatalogo(cat) {
            try {
                localStorage.setItem(LS_CATALOGO, JSON.stringify(cat));
                actualizarFecha();
                return true;
            } catch(e) {
                console.error("Error al guardar cat√°logo:", e);
                return false;
            }
        }
        
        function agregarCatalogo() {
            const h = document.getElementById('new-hc').value.trim();
            const n = document.getElementById('new-name').value.trim();
            
            if (!h || !n) {
                mostrarAlerta('error', 'Complete ambos campos');
                return;
            }
            
            let cat = obtenerCatalogo();
            if (cat.some(c => c.h === h)) {
                mostrarAlerta('error', 'Homoclave ya existe');
                return;
            }
            
            cat.push({h, n});
            if (guardarCatalogo(cat)) {
                document.getElementById('new-hc').value = '';
                document.getElementById('new-name').value = '';
                renderizarCatalogo();
                renderizarSelector();
                actualizarFiltroTramites();
                mostrarAlerta('success', 'Tr√°mite agregado');
            }
        }
        
        function eliminarDelCatalogo(homoclave) {
            if (!confirm('¬øEliminar este tr√°mite del cat√°logo?')) return;
            
            let cat = obtenerCatalogo().filter(c => c.h !== homoclave);
            if (guardarCatalogo(cat)) {
                renderizarCatalogo();
                renderizarSelector();
                actualizarFiltroTramites();
                mostrarAlerta('success', 'Tr√°mite eliminado');
            }
        }
        
        async function registrarLocal() {
            const asunto = document.getElementById('txt-asunto').value.trim();
            const bitacora = document.getElementById('txt-bitacora').value.trim();
            const tramite = document.getElementById('sel-tramite').value;
            
            if (!asunto || asunto.length < 10) {
                mostrarAlerta('error', 'El asunto debe tener m√≠nimo 10 caracteres');
                return;
            }
            if (asunto.length > 500) {
                mostrarAlerta('error', 'El asunto debe tener m√°ximo 500 caracteres');
                return;
            }
            
            if (conectado) {
                mostrarCargando(true, 'Verificando consecutivo...');
                try {
                    await cargarUltimoConsecutivoNube();
                } catch(e) {
                    console.error("Error al actualizar consecutivo:", e);
                } finally {
                    mostrarCargando(false);
                }
            }
            
            const anio = new Date().getFullYear();
            const consecutivo = obtenerProximoConsecutivo();
            const determinante = `OR-130/${AREA_SIGLAS}/${String(consecutivo).padStart(4, '0')}/${anio}`;
            
            const nuevo = {
                id: Date.now().toString(),
                determinante,
                consecutivo,
                anio,
                area_siglas: AREA_SIGLAS,
                homoclave: tramite,
                bitacora_referencia: bitacora,
                asunto,
                fecha: new Date().toISOString(),
                sincronizado: false,
                bloqueado: false,
                origen: 'local'
            };
            
            registrosPendientes.push(nuevo);
            todosLosRegistros.unshift(nuevo); // Agregar al inicio
            
            if (guardarPendientesLocal()) {
                ultimoConsecutivoNube = Math.max(ultimoConsecutivoNube, consecutivo);
                localStorage.setItem(LS_ULTIMO_CONSECUTIVO, ultimoConsecutivoNube.toString());
                
                limpiarFormulario();
                aplicarFiltros();
                actualizarEstadisticas();
                actualizarVistaProximoFolio();
                mostrarAlerta('success', 'Determinante creado: ' + determinante);
                
                if (conectado) {
                    setTimeout(() => {
                        if (confirm('¬øDesea sincronizar este registro con la nube ahora?')) {
                            sincronizarConNube();
                        }
                    }, 1000);
                }
            }
        }
        
        function limpiarFormulario() {
            document.getElementById('txt-asunto').value = '';
            document.getElementById('txt-bitacora').value = '';
            document.getElementById('sel-tramite').value = '';
            document.getElementById('char-count').textContent = '0/500';
            document.getElementById('char-count').className = 'text-[10px] text-slate-500 font-bold';
        }
        
        async function sincronizarConNube() {
            if (!conectado) {
                mostrarAlerta('error', 'No hay conexi√≥n');
                return;
            }
            
            if (registrosPendientes.length === 0) {
                mostrarAlerta('info', 'No hay registros pendientes de sincronizar');
                return;
            }
            
            mostrarCargando(true, 'Sincronizando...');
            
            try {
                await cargarUltimoConsecutivoNube();
                
                const datos = registrosPendientes.map(r => ({
                    determinante: r.determinante,
                    consecutivo: r.consecutivo,
                    anio: r.anio,
                    area_siglas: r.area_siglas,
                    homoclave: r.homoclave || null,
                    bitacora_referencia: r.bitacora_referencia || null,
                    asunto: r.asunto,
                    fecha: r.fecha
                }));
                
                const { error } = await _sb
                    .from('registro_oficios')
                    .insert(datos);
                
                if (error) throw error;
                
                // Actualizar registros sincronizados
                registrosPendientes.forEach(regPend => {
                    const idx = todosLosRegistros.findIndex(r => r.determinante === regPend.determinante);
                    if (idx !== -1) {
                        todosLosRegistros[idx].sincronizado = true;
                        todosLosRegistros[idx].bloqueado = true;
                        todosLosRegistros[idx].origen = 'nube';
                    }
                });
                
                const cantSincronizados = registrosPendientes.length;
                registrosPendientes = [];
                guardarPendientesLocal();
                
                await cargarUltimoConsecutivoNube();
                await sincronizarCatalogoConNube();
                
                aplicarFiltros();
                actualizarEstadisticas();
                actualizarVistaProximoFolio();
                actualizarUltimaSincronizacion();
                
                mostrarAlerta('success', `${cantSincronizados} registros sincronizados exitosamente`);
            } catch (e) {
                console.error("Error sync:", e);
                mostrarAlerta('error', 'Error al sincronizar: ' + e.message);
            } finally {
                mostrarCargando(false);
            }
        }
        
        async function sincronizarCatalogoConNube() {
            if (!conectado) return;
            
            const cat = obtenerCatalogo();
            if (cat.length === 0) return;
            
            try {
                for (let item of cat) {
                    const { data } = await _sb
                        .from('catalogo_tramites')
                        .select('homoclave')
                        .eq('area_siglas', AREA_SIGLAS)
                        .eq('homoclave', item.h)
                        .maybeSingle();
                    
                    if (!data) {
                        await _sb.from('catalogo_tramites').insert({
                            area_siglas: AREA_SIGLAS,
                            homoclave: item.h,
                            nombre_tramite: item.n
                        });
                    }
                }
                console.log("‚úì Cat√°logo sincronizado");
            } catch (error) {
                console.error("Error sync cat√°logo:", error);
            }
        }
        
        async function cargarCatalogoDesdeNube() {
            if (!conectado) return;
            
            try {
                const { data, error } = await _sb
                    .from('catalogo_tramites')
                    .select('*')
                    .eq('area_siglas', AREA_SIGLAS)
                    .order('homoclave');
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const catalogo = data.map(item => ({h: item.homoclave, n: item.nombre_tramite}));
                    guardarCatalogo(catalogo);
                    console.log("‚úì Cat√°logo cargado");
                }
            } catch (error) {
                console.error("Error al cargar cat√°logo:", error);
            }
        }
        
        function eliminarRegistro(determinante) {
            const reg = todosLosRegistros.find(r => r.determinante === determinante);
            
            if (!reg) return;
            
            if (reg.sincronizado || reg.bloqueado) {
                mostrarAlerta('error', 'No se puede eliminar un registro sincronizado');
                return;
            }
            
            if (!confirm('¬øEliminar ' + determinante + '?\n\nEsta acci√≥n no se puede deshacer.')) return;
            
            // Eliminar de memoria
            todosLosRegistros = todosLosRegistros.filter(r => r.determinante !== determinante);
            
            // Eliminar de pendientes
            registrosPendientes = registrosPendientes.filter(r => r.determinante !== determinante);
            guardarPendientesLocal();
            
            aplicarFiltros();
            actualizarEstadisticas();
            actualizarVistaProximoFolio();
            mostrarAlerta('success', 'Registro eliminado');
        }
        
        function verDetalle(determinante) {
            const reg = todosLosRegistros.find(r => r.determinante === determinante);
            if (!reg) return;
            
            const fecha = new Date(reg.fecha).toLocaleString('es-MX', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });
            
            const estado = reg.sincronizado ? 
                '<span class="badge bg-blue-100 text-blue-800"><i class="fas fa-cloud-check"></i> Sincronizado</span>' :
                '<span class="badge bg-amber-100 text-amber-800"><i class="fas fa-clock"></i> Pendiente</span>';
            
            const html = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="p-4 bg-emerald-50 rounded-lg">
                            <p class="text-xs text-slate-500 font-bold mb-1">DETERMINANTE</p>
                            <p class="text-lg font-bold text-emerald-700 font-mono">${reg.determinante}</p>
                        </div>
                        <div class="p-4 bg-blue-50 rounded-lg">
                            <p class="text-xs text-slate-500 font-bold mb-1">ESTADO</p>
                            <div class="mt-2">${estado}</div>
                        </div>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg">
                        <p class="text-xs text-slate-500 font-bold mb-2"><i class="fas fa-folder mr-1"></i> HOMOCLAVE</p>
                        <p class="text-sm font-bold text-slate-800">${reg.homoclave || 'No especificado'}</p>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg">
                        <p class="text-xs text-slate-500 font-bold mb-2"><i class="fas fa-hashtag mr-1"></i> BIT√ÅCORA</p>
                        <p class="text-sm text-slate-700">${reg.bitacora_referencia || 'No especificado'}</p>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg">
                        <p class="text-xs text-slate-500 font-bold mb-2"><i class="fas fa-align-left mr-1"></i> ASUNTO</p>
                        <p class="text-sm text-slate-700 leading-relaxed">${reg.asunto}</p>
                    </div>
                    <div class="p-4 bg-slate-50 rounded-lg">
                        <p class="text-xs text-slate-500 font-bold mb-2"><i class="fas fa-calendar-alt mr-1"></i> FECHA</p>
                        <p class="text-sm text-slate-700">${fecha}</p>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-view-content').innerHTML = html;
            document.getElementById('modal-view').style.display = 'block';
        }
        
        function cerrarModal(id) {
            document.getElementById(id).style.display = 'none';
        }
        
        function duplicarRegistro(determinante) {
            const reg = todosLosRegistros.find(r => r.determinante === determinante);
            if (!reg) return;
            
            document.getElementById('sel-tramite').value = reg.homoclave || '';
            document.getElementById('txt-bitacora').value = '';
            document.getElementById('txt-asunto').value = reg.asunto;
            document.getElementById('char-count').textContent = reg.asunto.length + '/500';
            window.scrollTo({top: 0, behavior: 'smooth'});
            mostrarAlerta('info', 'Registro duplicado - se generar√° nuevo folio al guardar');
        }
        
        // FUNCIONES DE FILTRADO Y PAGINACI√ìN
        
        function actualizarFiltrosAnio() {
            const anios = [...new Set(todosLosRegistros.map(r => r.anio))].sort((a, b) => b - a);
            const container = document.getElementById('year-filters');
            
            let html = '<span class="year-badge ' + (filtroAnio === 'todos' ? 'active' : '') + '" onclick="filtrarPorAnio(\'todos\')">Todos</span>';
            
            anios.forEach(anio => {
                html += `<span class="year-badge ${filtroAnio === anio ? 'active' : ''}" onclick="filtrarPorAnio(${anio})">${anio}</span>`;
            });
            
            container.innerHTML = html;
        }
        
        function filtrarPorAnio(anio) {
            filtroAnio = anio;
            paginaActual = 1;
            aplicarFiltros();
            actualizarFiltrosAnio();
        }
        
        function actualizarFiltroTramites() {
            const cat = obtenerCatalogo();
            const select = document.getElementById('filter-tramite');
            
            let html = '<option value="">Todos</option>';
            cat.forEach(c => {
                html += `<option value="${c.h}">${c.h} - ${c.n}</option>`;
            });
            
            select.innerHTML = html;
        }
        
        function aplicarFiltros() {
            const busqueda = document.getElementById('search-input').value.toLowerCase();
            const tramiteFiltro = document.getElementById('filter-tramite').value;
            const orden = document.getElementById('sort-order').value;
            
            // Aplicar filtros
            registrosFiltrados = todosLosRegistros.filter(reg => {
                // Filtro de a√±o
                if (filtroAnio !== 'todos' && reg.anio !== filtroAnio) {
                    return false;
                }
                
                // Filtro de tr√°mite
                if (tramiteFiltro && reg.homoclave !== tramiteFiltro) {
                    return false;
                }
                
                // Filtro de b√∫squeda
                if (busqueda) {
                    const textoCompleto = `${reg.determinante} ${reg.asunto} ${reg.homoclave || ''} ${reg.bitacora_referencia || ''}`.toLowerCase();
                    if (!textoCompleto.includes(busqueda)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Ordenar
            registrosFiltrados.sort((a, b) => {
                const fechaA = new Date(a.fecha);
                const fechaB = new Date(b.fecha);
                return orden === 'desc' ? fechaB - fechaA : fechaA - fechaB;
            });
            
            // Actualizar subt√≠tulo
            let subtitle = `${registrosFiltrados.length} registros`;
            if (filtroAnio !== 'todos') {
                subtitle += ` del a√±o ${filtroAnio}`;
            }
            document.getElementById('subtitle-registros').textContent = subtitle;
            
            paginaActual = 1;
            renderizarTabla();
        }
        
        function cambiarItemsPorPagina() {
            const valor = document.getElementById('items-per-page').value;
            itemsPorPagina = valor === 'all' ? registrosFiltrados.length : parseInt(valor);
            paginaActual = 1;
            renderizarTabla();
        }
        
        function cambiarPagina(direccion) {
            const totalPaginas = Math.ceil(registrosFiltrados.length / itemsPorPagina);
            paginaActual = Math.max(1, Math.min(totalPaginas, paginaActual + direccion));
            renderizarTabla();
        }
        
        function irAPagina(pagina) {
            paginaActual = pagina;
            renderizarTabla();
        }
        
        function irAPaginaFinal() {
            const totalPaginas = Math.ceil(registrosFiltrados.length / itemsPorPagina);
            paginaActual = totalPaginas;
            renderizarTabla();
        }
        
        // FUNCIONES DE RENDERIZADO
        
        function renderizarTodo() {
            renderizarCatalogo();
            renderizarSelector();
            aplicarFiltros();
            actualizarEstadisticas();
            actualizarFiltrosAnio();
            actualizarFiltroTramites();
        }
        
        function renderizarCatalogo() {
            const cat = obtenerCatalogo();
            const lista = document.getElementById('catalogo-list');
            document.getElementById('count-tramites').textContent = cat.length;
            
            if (cat.length === 0) {
                lista.innerHTML = '<p class="text-xs text-slate-500 italic text-center py-2">Sin tr√°mites</p>';
                return;
            }
            
            lista.innerHTML = cat.map(c => `
                <div class="flex items-center justify-between bg-white p-2 rounded border border-slate-200">
                    <div class="flex-1">
                        <p class="text-xs font-bold text-slate-700">${c.h}</p>
                        <p class="text-[10px] text-slate-500">${c.n}</p>
                    </div>
                    <button onclick="eliminarDelCatalogo('${c.h}')" class="text-red-400 hover:text-red-600 px-2">
                        <i class="fas fa-trash text-xs"></i>
                    </button>
                </div>
            `).join('');
        }
        
        function renderizarSelector() {
            const cat = obtenerCatalogo();
            const sel = document.getElementById('sel-tramite');
            
            sel.innerHTML = cat.length === 0 ? 
                '<option value="">-- Sin tr√°mites --</option>' :
                '<option value="">-- Seleccione --</option>' + 
                cat.map(c => `<option value="${c.h}">${c.h} - ${c.n}</option>`).join('');
        }
        
        function renderizarTabla() {
            const tbody = document.getElementById('table-body');
            
            if (registrosFiltrados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="3" class="p-12 text-center text-slate-400">
                            <i class="fas fa-inbox text-5xl mb-3 opacity-50"></i>
                            <p class="font-semibold">No hay registros que coincidan con los filtros</p>
                        </td>
                    </tr>
                `;
                document.getElementById('pagination-controls').style.display = 'none';
                return;
            }
            
            // Calcular paginaci√≥n
            const totalPaginas = Math.ceil(registrosFiltrados.length / itemsPorPagina);
            const inicio = (paginaActual - 1) * itemsPorPagina;
            const fin = Math.min(inicio + itemsPorPagina, registrosFiltrados.length);
            const registrosPagina = registrosFiltrados.slice(inicio, fin);
            
            tbody.innerHTML = registrosPagina.map(r => {
                const fecha = new Date(r.fecha).toLocaleDateString('es-MX', {
                    day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
                });
                const rowClass = r.sincronizado ? 'row-synced' : 'row-local';
                const asunto = r.asunto.length > 100 ? r.asunto.substring(0, 100) + '...' : r.asunto;
                
                return `
                    <tr class="table-row-hover ${rowClass}">
                        <td class="p-4">
                            <div class="space-y-1">
                                <p class="font-bold text-slate-900 font-mono text-sm">${r.determinante}</p>
                                <p class="text-[10px] text-slate-500"><i class="fas fa-calendar-alt mr-1"></i>${fecha}</p>
                                <p class="text-xs font-bold text-purple-700 mt-1"><i class="fas fa-folder mr-1"></i>${r.homoclave || 'N/A'}</p>
                                <p class="text-[10px] text-slate-600"><i class="fas fa-hashtag mr-1"></i>${r.bitacora_referencia || 'N/A'}</p>
                                <p class="text-xs text-slate-700 mt-1">${asunto}</p>
                            </div>
                        </td>
                        <td class="p-4 text-center">
                            ${r.sincronizado ? 
                                '<span class="badge bg-blue-100 text-blue-800"><i class="fas fa-cloud-check"></i> Sincronizado</span>' :
                                '<span class="badge bg-amber-100 text-amber-800"><i class="fas fa-clock"></i> Pendiente</span>'}
                        </td>
                        <td class="p-4">
                            <div class="flex items-center justify-center gap-1">
                                <button onclick="verDetalle('${r.determinante}')" class="btn-action p-2 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-lg" title="Ver">
                                    <i class="fas fa-eye"></i>
                                </button>
                                ${(!r.sincronizado && !r.bloqueado) ? 
                                    `<button onclick="eliminarRegistro('${r.determinante}')" class="btn-action p-2 bg-red-100 hover:bg-red-200 text-red-700 rounded-lg" title="Eliminar">
                                        <i class="fas fa-trash"></i>
                                    </button>` :
                                    '<span class="text-slate-400 text-xs px-2" title="Protegido"><i class="fas fa-lock"></i></span>'}
                                <button onclick="duplicarRegistro('${r.determinante}')" class="btn-action p-2 bg-purple-100 hover:bg-purple-200 text-purple-700 rounded-lg" title="Duplicar">
                                    <i class="fas fa-copy"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Actualizar controles de paginaci√≥n
            if (totalPaginas > 1) {
                document.getElementById('pagination-controls').style.display = 'flex';
                document.getElementById('current-page').textContent = paginaActual;
                document.getElementById('total-pages').textContent = totalPaginas;
                
                // Deshabilitar botones seg√∫n corresponda
                const btnPrev = document.querySelector('.pagination-controls button:nth-child(2)');
                const btnNext = document.querySelector('.pagination-controls button:nth-child(4)');
                btnPrev.disabled = paginaActual === 1;
                btnNext.disabled = paginaActual === totalPaginas;
            } else {
                document.getElementById('pagination-controls').style.display = 'none';
            }
        }
        
        function actualizarEstadisticas() {
            const ahora = new Date();
            const semanaAtras = new Date(ahora.getTime() - 7 * 24 * 60 * 60 * 1000);
            const mesAtras = new Date(ahora.getFullYear(), ahora.getMonth() - 1, ahora.getDate());
            const anioActual = ahora.getFullYear();
            
            const sincronizados = todosLosRegistros.filter(r => r.sincronizado).length;
            const pendientes = todosLosRegistros.filter(r => !r.sincronizado).length;
            const semana = todosLosRegistros.filter(r => new Date(r.fecha) >= semanaAtras).length;
            const mes = todosLosRegistros.filter(r => new Date(r.fecha) >= mesAtras).length;
            const anio = todosLosRegistros.filter(r => r.anio === anioActual).length;
            
            document.getElementById('stat-total').textContent = todosLosRegistros.length;
            document.getElementById('stat-nube').textContent = sincronizados;
            document.getElementById('stat-pendientes').textContent = pendientes;
            document.getElementById('stat-semana').textContent = semana;
            document.getElementById('stat-mes').textContent = mes;
            document.getElementById('stat-anio').textContent = anio;
            document.getElementById('memory-count').textContent = todosLosRegistros.length;
        }
        
        function exportarCSV() {
            if (registrosFiltrados.length === 0) {
                mostrarAlerta('info', 'No hay datos para exportar');
                return;
            }
            
            let csv = 'Determinante,Consecutivo,A√±o,√Årea,Homoclave,Bit√°cora,Asunto,Fecha,Estado\n';
            csv += registrosFiltrados.map(r => 
                `"${r.determinante}",${r.consecutivo},${r.anio},"${r.area_siglas}","${r.homoclave || ''}","${r.bitacora_referencia || ''}","${r.asunto.replace(/"/g, '""')}","${r.fecha}","${r.sincronizado ? 'Sincronizado' : 'Pendiente'}"`
            ).join('\n');
            
            const blob = new Blob(['\ufeff' + csv], {type: 'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Export_${AREA_SIGLAS}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            mostrarAlerta('success', `${registrosFiltrados.length} registros exportados`);
        }
        
        function imprimirTabla() {
            window.print();
        }
        
        function limpiarCache() {
            if (!confirm('¬øEst√° seguro de limpiar toda la cach√© local?\n\nEsto eliminar√°:\n- Todos los registros cargados en memoria\n- Configuraci√≥n de filtros\n\nLos registros pendientes de sincronizar se mantendr√°n seguros.')) {
                return;
            }
            
            // Solo limpiar registros en memoria, mantener pendientes
            todosLosRegistros = [...registrosPendientes];
            registrosFiltrados = [];
            paginaActual = 1;
            filtroAnio = 'todos';
            
            renderizarTodo();
            mostrarAlerta('success', 'Cach√© limpiada. Los registros pendientes se mantuvieron.');
        }
        
        function actualizarFecha() {
            const fecha = new Date().toLocaleString('es-MX', {day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'});
            document.getElementById('last-update').textContent = fecha;
        }
        
        function actualizarUltimaSincronizacion() {
            try {
                const ultimaSync = localStorage.getItem(LS_ULTIMA_SYNC);
                if (ultimaSync) {
                    document.getElementById('last-sync').textContent = ultimaSync;
                } else {
                    document.getElementById('last-sync').textContent = '--';
                }
                
                // Guardar nueva fecha de sincronizaci√≥n
                const fecha = new Date().toLocaleString('es-MX', {day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit'});
                localStorage.setItem(LS_ULTIMA_SYNC, fecha);
            } catch(e) {
                console.error("Error al actualizar √∫ltima sincronizaci√≥n:", e);
            }
        }
        
        function mostrarCargando(mostrar, mensaje = 'Cargando...') {
            let overlay = document.getElementById('loading-overlay');
            if (mostrar) {
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.id = 'loading-overlay';
                    overlay.className = 'loading-overlay';
                    document.body.appendChild(overlay);
                }
                overlay.innerHTML = `
                    <div class="text-center">
                        <div class="spinner mx-auto mb-4"></div>
                        <p class="text-white font-bold text-lg">${mensaje}</p>
                    </div>
                `;
            } else {
                if (overlay) overlay.remove();
            }
        }
        
        function mostrarAlerta(tipo, mensaje) {
            const colores = {success: 'bg-emerald-500', error: 'bg-red-500', warning: 'bg-amber-500', info: 'bg-blue-500'};
            const iconos = {success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle'};
            
            const alerta = document.createElement('div');
            alerta.className = `fixed top-4 right-4 ${colores[tipo]} text-white px-6 py-4 rounded-lg shadow-2xl z-50 flex items-start gap-3 animate-fade-in max-w-md`;
            alerta.innerHTML = `
                <i class="fas ${iconos[tipo]} text-xl mt-0.5"></i>
                <div class="flex-1">
                    <div class="font-bold mb-1">${tipo.toUpperCase()}</div>
                    <div class="text-sm">${mensaje}</div>
                </div>
                <button onclick="this.parentElement.remove()" class="text-white text-xl hover:bg-white hover:bg-opacity-20 p-1 rounded">√ó</button>
            `;
            document.body.appendChild(alerta);
            
            setTimeout(() => {
                alerta.style.opacity = '0';
                alerta.style.transition = 'opacity 0.3s';
                setTimeout(() => alerta.remove(), 300);
            }, 5000);
        }
        
        window.onclick = function(event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        };
    </script>
</body>
</html>
