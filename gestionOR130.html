<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Workflow OR-130 Mejorado v4 - SEMARNAT Durango</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Google Drive API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        .gradient-bg { background: linear-gradient(135deg, #13322B 0%, #1a4838 100%); }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; }
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        
        .group:hover .opacity-0 {
            opacity: 1 !important;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .animate-fadeIn {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Etapas con l칤nea de tiempo */
        .timeline-container {
            position: relative;
            padding: 20px 0;
        }
        
        .timeline-item {
            position: relative;
            padding-left: 40px;
            margin-bottom: 20px;
        }
        
        .timeline-dot {
            position: absolute;
            left: 0;
            top: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            z-index: 2;
        }
        
        .timeline-line {
            position: absolute;
            left: 11px;
            top: 32px;
            width: 2px;
            height: calc(100% - 32px);
            background: #e5e7eb;
        }
        
        .timeline-item.active .timeline-dot {
            background: #10b981;
            color: white;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2);
        }
        
        .timeline-item.completed .timeline-dot {
            background: #3b82f6;
            color: white;
        }
        
        .timeline-item.blocked .timeline-dot {
            background: #ef4444;
            color: white;
        }
        
        .timeline-item.pending .timeline-dot {
            background: #d1d5db;
            color: #6b7280;
        }
        
        /* Estilos de documentos mejorados */
        .preview-container {
            position: relative;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            padding: 20px;
            background: #f8fafc;
            transition: all 0.3s;
        }
        .preview-container:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        .preview-item {
            position: relative;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        .preview-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        .preview-pdf {
            width: 100%;
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #fee2e2;
        }
        .remove-preview {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .remove-preview:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        /* Visor de documentos */
        .doc-viewer {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .doc-viewer-content {
            max-width: 90vw;
            max-height: 90vh;
            position: relative;
        }
        .doc-viewer-image {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            transition: transform 0.3s;
        }
        .doc-viewer-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px 25px;
            border-radius: 50px;
            display: flex;
            gap: 15px;
        }
        .doc-viewer-btn {
            background: white;
            color: black;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .doc-viewer-btn:hover {
            background: #3b82f6;
            color: white;
            transform: scale(1.1);
        }
        .doc-viewer-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            transition: all 0.2s;
        }
        .doc-viewer-close:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        /* Notificaciones toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            min-width: 300px;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideInRight 0.3s ease-out;
            background: white;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(400px); opacity: 0; }
        }
        
        .toast.removing {
            animation: slideOutRight 0.3s ease-out forwards;
        }
        
        .toast-success {
            border-left: 4px solid #10b981;
        }
        
        .toast-error {
            border-left: 4px solid #ef4444;
        }
        
        .toast-warning {
            border-left: 4px solid #f59e0b;
        }
        
        .toast-info {
            border-left: 4px solid #3b82f6;
        }
        
        .toast-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .toast-message {
            font-size: 14px;
            color: #6b7280;
        }
        
        .toast-close {
            cursor: pointer;
            color: #9ca3af;
            transition: color 0.2s;
            flex-shrink: 0;
        }
        
        .toast-close:hover {
            color: #374151;
        }
        
        /* Badge de Google Drive */
        .drive-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            background: #4285f4;
            color: white;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Historial de cambios */
        .history-item {
            border-left: 3px solid #e5e7eb;
            padding-left: 15px;
            margin-bottom: 15px;
            transition: all 0.2s;
        }
        
        .history-item:hover {
            border-left-color: #3b82f6;
            background: #f8fafc;
            padding-left: 20px;
        }
        
        /* Botones de control de etapa */
        .stage-control-btn {
            transition: all 0.2s;
        }
        
        .stage-control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .stage-control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .stage-control-btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Visor de Documentos -->
    <div id="docViewer" class="doc-viewer hidden">
        <button onclick="cerrarVisor()" class="doc-viewer-close">
            <i class="fas fa-times"></i>
        </button>
        <div class="doc-viewer-content">
            <img id="viewerImage" class="doc-viewer-image" alt="Documento">
            <iframe id="viewerPDF" class="hidden" style="width: 90vw; height: 90vh; border: none;"></iframe>
            <div class="doc-viewer-controls">
                <button onclick="navegarDoc(-1)" class="doc-viewer-btn" title="Anterior">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span id="viewerCounter" class="text-white text-sm font-medium">1 / 1</span>
                <button onclick="navegarDoc(1)" class="doc-viewer-btn" title="Siguiente">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <button onclick="zoomDoc(-0.2)" class="doc-viewer-btn" title="Alejar">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button onclick="resetZoom()" class="doc-viewer-btn" title="Zoom 100%">
                    <i class="fas fa-expand"></i>
                </button>
                <button onclick="zoomDoc(0.2)" class="doc-viewer-btn" title="Acercar">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button onclick="descargarDocActual()" class="doc-viewer-btn" title="Descargar">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="gradient-bg shadow-lg">
        <div class="container mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                                <div class="flex items-center gap-4">
              -游쓇릛쓇릛-
                    <div>
                        <h1 class="text-2xl font-bold text-white">Sistema de Gesti칩n OR-130</h1>
                        <p class="text-green-100">SEMARNAT Durango - Control de Determinantes v4.0</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Bot칩n Google Drive -->
                    <button id="driveConnectBtn" onclick="conectarDrive()" 
                            class="bg-white text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-100 transition flex items-center gap-2">
                        <i class="fab fa-google-drive text-blue-600"></i>
                        <span id="driveStatus">Conectar Drive</span>
                    </button>
                    <button onclick="location.reload()" class="bg-white bg-opacity-20 text-white px-4 py-2 rounded-lg hover:bg-opacity-30 transition">
                        <i class="fas fa-sync-alt mr-2"></i>Actualizar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Dashboard Principal -->
    <main class="container mx-auto px-4 py-8">
        <!-- Indicadores Principales -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Total Determinantes</p>
                        <p id="totalOficios" class="text-3xl font-bold text-gray-800 mt-1">0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <i class="fas fa-file-alt text-blue-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Etapa 2: Firma</p>
                        <p id="firmasPendientes" class="text-3xl font-bold text-orange-600 mt-1">0</p>
                    </div>
                    <div class="bg-orange-100 p-3 rounded-full">
                        <i class="fas fa-signature text-orange-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Etapa 3: Notificaci칩n</p>
                        <p id="notificacionesPendientes" class="text-3xl font-bold text-purple-600 mt-1">0</p>
                    </div>
                    <div class="bg-purple-100 p-3 rounded-full">
                        <i class="fas fa-bell text-purple-600 text-2xl"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Etapa 4: Expediente</p>
                        <p id="expedientesCompletados" class="text-3xl font-bold text-green-600 mt-1">0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <i class="fas fa-folder-open text-green-600 text-2xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabla Principal -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="p-6 border-b border-gray-200">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input id="searchInput" type="text" placeholder="Buscar determinante, 치rea..."
                                   class="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent w-64">
                            <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                        </div>
                        <select id="filterArea" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            <option value="">Todas las 츼reas</option>
                        </select>
                        <select id="filterEtapa" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            <option value="">Todas las Etapas</option>
                            <option value="1">Etapa 1: Captura</option>
                            <option value="2">Etapa 2: Firma</option>
                            <option value="3">Etapa 3: Notificaci칩n</option>
                            <option value="4">Etapa 4: Expediente</option>
                        </select>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button onclick="exportarExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition flex items-center">
                            <i class="fas fa-file-excel mr-2"></i>Exportar Excel
                        </button>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Determinante</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">츼rea</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Etapa</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Documentos</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Drive</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaOficios" class="bg-white divide-y divide-gray-200">
                        <!-- Se llena din치micamente -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Modal Principal -->
    <div id="modalOficio" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-xl shadow-2xl max-w-6xl w-full max-h-[95vh] overflow-y-auto">
            <div class="gradient-bg p-6 sticky top-0 z-10">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-white">
                        <i class="fas fa-file-alt mr-2"></i>
                        <span id="modalDeterminante">Determinante</span>
                    </h2>
                    <button onclick="cerrarModal()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <!-- Informaci칩n General -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">츼rea Responsable</label>
                        <p id="modalArea" class="text-lg font-semibold text-gray-900"></p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fecha de Captura</label>
                        <p id="modalFecha" class="text-lg text-gray-900"></p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Asunto</label>
                        <p id="modalAsunto" class="text-gray-900"></p>
                    </div>
                </div>

                <!-- Control de Etapas Mejorado -->
                <div class="mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-bold text-gray-900">
                            <i class="fas fa-tasks mr-2 text-green-600"></i>
                            Control de Etapas del Workflow
                        </h3>
                        <div id="driveInfo" class="hidden">
                            <span class="drive-badge">
                                <i class="fab fa-google-drive"></i>
                                Respaldado en Drive
                            </span>
                        </div>
                    </div>
                    
                    <div id="timelineEtapas" class="timeline-container">
                        <!-- Se llena din치micamente -->
                    </div>

                    <!-- Botones de Control -->
                    <div class="flex flex-wrap gap-3 mt-6 p-4 bg-gray-50 rounded-lg">
                        <button id="btnAvanzarEtapa" onclick="avanzarEtapa()" 
                                class="stage-control-btn bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2">
                            <i class="fas fa-arrow-right"></i>
                            Avanzar Etapa
                        </button>
                        <button id="btnRetrocederEtapa" onclick="retrocederEtapa()" 
                                class="stage-control-btn bg-orange-600 text-white px-6 py-2 rounded-lg hover:bg-orange-700 transition flex items-center gap-2">
                            <i class="fas fa-arrow-left"></i>
                            Retroceder Etapa
                        </button>
                        <button id="btnBloquearEtapa" onclick="toggleBloqueoEtapa()" 
                                class="stage-control-btn bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 transition flex items-center gap-2">
                            <i class="fas fa-lock"></i>
                            <span id="textBloqueo">Bloquear Etapa</span>
                        </button>
                        <button onclick="mostrarHistorialEtapas()" 
                                class="stage-control-btn bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                            <i class="fas fa-history"></i>
                            Ver Historial
                        </button>
                    </div>
                </div>

                <!-- Gesti칩n de Documentos -->
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">
                        <i class="fas fa-paperclip mr-2 text-blue-600"></i>
                        Gesti칩n de Documentos Digitalizados
                    </h3>
                    
                    <!-- Carga de Documentos -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Cargar Nuevos Documentos (PDF, JPG, PNG)
                        </label>
                        <div class="flex gap-3">
                            <input type="file" id="inputArchivos" multiple accept="image/*,application/pdf" 
                                   class="flex-1 border border-gray-300 rounded-lg p-2" onchange="previsualizarArchivos()">
                            <button onclick="subirDocumentos()" 
                                    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition flex items-center gap-2">
                                <i class="fas fa-cloud-upload-alt"></i>
                                Subir a Sistema
                            </button>
                            <button id="btnSubirDrive" onclick="subirDocumentosDrive()" 
                                    class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition flex items-center gap-2"
                                    disabled>
                                <i class="fab fa-google-drive"></i>
                                Respaldar en Drive
                            </button>
                        </div>
                    </div>

                    <!-- Previsualizaci칩n -->
                    <div id="previsualizacion" class="hidden mb-4">
                        <p class="text-sm font-medium text-gray-700 mb-2">Documentos a cargar:</p>
                        <div id="listaPreview" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                    </div>

                    <!-- Documentos Existentes -->
                    <div id="listaDocumentos">
                        <!-- Se llena din치micamente -->
                    </div>
                </div>

                <!-- Observaciones y Comentarios -->
                <div class="mb-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-4">
                        <i class="fas fa-comments mr-2 text-purple-600"></i>
                        Observaciones y Comentarios
                    </h3>
                    <div class="space-y-3">
                        <textarea id="nuevaObservacion" rows="3" 
                                  class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-green-500"
                                  placeholder="Agregar observaci칩n o comentario sobre esta determinante..."></textarea>
                        <button onclick="agregarObservacion()" 
                                class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 transition">
                            <i class="fas fa-plus mr-2"></i>
                            Agregar Observaci칩n
                        </button>
                    </div>
                    <div id="listaObservaciones" class="mt-4 space-y-3">
                        <!-- Se llena din치micamente -->
                    </div>
                </div>

                <!-- Historial de Auditor칤a -->
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">
                        <i class="fas fa-clipboard-list mr-2 text-indigo-600"></i>
                        Registro de Auditor칤a
                    </h3>
                    <div id="listaAuditoria" class="space-y-2 max-h-60 overflow-y-auto">
                        <!-- Se llena din치micamente -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Historial -->
    <div id="modalHistorial" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4" style="display: none;">
        <div class="bg-white rounded-xl shadow-2xl max-w-3xl w-full max-h-[80vh] overflow-y-auto">
            <div class="gradient-bg p-6">
                <div class="flex items-center justify-between">
                    <h2 class="text-2xl font-bold text-white">
                        <i class="fas fa-history mr-2"></i>
                        Historial de Cambios de Etapa
                    </h2>
                    <button onclick="cerrarModalHistorial()" class="text-white hover:bg-white hover:bg-opacity-20 rounded-full p-2 transition">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
            </div>
            <div class="p-6">
                <div id="contenidoHistorial" class="space-y-3">
                    <!-- Se llena din치micamente -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci칩n
        const SUPABASE_URL = 'https://rnwksmgwmnjatrgezaaa.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJud2tzbWd3bW5qYXRyZ2V6YWFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5MTY1MTYsImV4cCI6MjA4MzQ5MjUxNn0.vQXfHnWRuCNOjbqX-iYragObPA9GyCw9z9RMsNLjEfE';
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Google Drive Configuration
        const GOOGLE_CLIENT_ID = 'TU_GOOGLE_CLIENT_ID';
        const GOOGLE_API_KEY = 'TU_GOOGLE_API_KEY';
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // Variables globales
        let datosOriginales = [];
        let datosFiltrados = [];
        let oficioActual = null;
        let archivosPendientes = [];
        let archivosPreview = [];
        let allDocsForViewer = [];
        let currentDocIndex = 0;
        let currentZoom = 1;
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;
        let accessToken = null;

        // Inicializaci칩n
        document.addEventListener('DOMContentLoaded', () => {
            cargarDatos();
            setupEventListeners();
            inicializarGoogleAPI();
        });

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', filtrarDatos);
            document.getElementById('filterArea').addEventListener('change', filtrarDatos);
            document.getElementById('filterEtapa').addEventListener('change', filtrarDatos);
        }

        // ====================== GOOGLE DRIVE API ======================
        
        function inicializarGoogleAPI() {
            gapi.load('client', initializeGapiClient);
            google.accounts.id.initialize({
                client_id: GOOGLE_CLIENT_ID,
                callback: handleCredentialResponse
            });
            
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: GOOGLE_CLIENT_ID,
                scope: SCOPES,
                callback: (response) => {
                    if (response.access_token) {
                        accessToken = response.access_token;
                        actualizarEstadoDrive(true);
                        showToast('Conectado a Google Drive exitosamente', 'success', 'Drive Conectado');
                    }
                },
            });
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                apiKey: GOOGLE_API_KEY,
                discoveryDocs: DISCOVERY_DOCS,
            });
            gapiInited = true;
        }

        function handleCredentialResponse(response) {
            // Manejar respuesta de credenciales
        }

        function conectarDrive() {
            if (accessToken) {
                showToast('Ya est치s conectado a Google Drive', 'info', 'Drive');
                return;
            }
            tokenClient.requestAccessToken();
        }

        function actualizarEstadoDrive(conectado) {
            const btn = document.getElementById('driveConnectBtn');
            const status = document.getElementById('driveStatus');
            const btnSubirDrive = document.getElementById('btnSubirDrive');
            
            if (conectado) {
                status.textContent = 'Drive Conectado';
                btn.classList.add('bg-green-100', 'text-green-800');
                btn.classList.remove('bg-white', 'text-gray-800');
                if (btnSubirDrive) btnSubirDrive.disabled = false;
            } else {
                status.textContent = 'Conectar Drive';
                btn.classList.remove('bg-green-100', 'text-green-800');
                btn.classList.add('bg-white', 'text-gray-800');
                if (btnSubirDrive) btnSubirDrive.disabled = true;
            }
        }

        async function crearCarpetaDrive(nombreDeterminante) {
            if (!accessToken) {
                showToast('Debes conectar Google Drive primero', 'warning', 'Drive no conectado');
                return null;
            }

            try {
                const fileMetadata = {
                    name: `OR-130_${nombreDeterminante}`,
                    mimeType: 'application/vnd.google-apps.folder'
                };

                const response = await fetch('https://www.googleapis.com/drive/v3/files', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(fileMetadata)
                });

                const folder = await response.json();
                return folder.id;
            } catch (error) {
                console.error('Error creando carpeta:', error);
                showToast('Error al crear carpeta en Drive', 'error', 'Error');
                return null;
            }
        }

        async function subirArchivoDrive(archivo, folderId) {
            if (!accessToken) return null;

            try {
                const metadata = {
                    name: archivo.nombre,
                    parents: [folderId]
                };

                // Convertir base64 a blob
                const base64Data = archivo.contenido.split(',')[1];
                const byteCharacters = atob(base64Data);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: archivo.tipo });

                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', blob);

                const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    },
                    body: form
                });

                const file = await response.json();
                return file.id;
            } catch (error) {
                console.error('Error subiendo archivo a Drive:', error);
                return null;
            }
        }

        async function subirDocumentosDrive() {
            if (!oficioActual) return;
            
            if (!accessToken) {
                showToast('Debes conectar Google Drive primero', 'warning', 'Drive no conectado');
                conectarDrive();
                return;
            }

            const documentos = oficioActual.documentos || [];
            if (documentos.length === 0) {
                showToast('No hay documentos para respaldar', 'warning', 'Sin documentos');
                return;
            }

            showToast(`Respaldando ${documentos.length} documento(s) en Drive...`, 'info', 'Procesando', 0);

            try {
                // Crear o obtener carpeta
                let folderId = oficioActual.drive_folder_id;
                if (!folderId) {
                    folderId = await crearCarpetaDrive(oficioActual.determinante);
                    if (!folderId) throw new Error('No se pudo crear la carpeta');
                    
                    // Guardar folder ID
                    await db.from('registro_oficios')
                        .update({ drive_folder_id: folderId })
                        .eq('id', oficioActual.id);
                }

                // Subir cada documento
                let exitosos = 0;
                for (const doc of documentos) {
                    if (!doc.drive_file_id) {
                        const fileId = await subirArchivoDrive(doc, folderId);
                        if (fileId) {
                            doc.drive_file_id = fileId;
                            exitosos++;
                        }
                    }
                }

                // Actualizar base de datos
                await db.from('registro_oficios')
                    .update({ 
                        documentos: documentos,
                        drive_folder_id: folderId,
                        drive_synced: true
                    })
                    .eq('id', oficioActual.id);

                document.getElementById('toastContainer').innerHTML = '';
                showToast(`${exitosos} documento(s) respaldados en Drive exitosamente`, 'success', 'Respaldo Completo');
                
                // Actualizar UI
                document.getElementById('driveInfo').classList.remove('hidden');
                await registrarAuditoria('drive_backup', `${exitosos} documentos respaldados en Google Drive`);
                cargarDatos();
                abrirModal(oficioActual);

            } catch (error) {
                document.getElementById('toastContainer').innerHTML = '';
                showToast(error.message, 'error', 'Error en Drive');
            }
        }

        async function abrirEnDrive() {
            if (!oficioActual || !oficioActual.drive_folder_id) {
                showToast('Esta determinante no tiene carpeta en Drive', 'warning', 'Sin carpeta');
                return;
            }

            const url = `https://drive.google.com/drive/folders/${oficioActual.drive_folder_id}`;
            window.open(url, '_blank');
        }

        // ====================== CARGA DE DATOS ======================

        async function cargarDatos() {
            try {
                const { data, error } = await db
                    .from('registro_oficios')
                    .select('*')
                    .order('fecha', { ascending: false });

                if (error) throw error;

                datosOriginales = data || [];
                datosFiltrados = [...datosOriginales];
                
                renderizarTabla();
                actualizarIndicadores();
                cargarFiltroAreas();
            } catch (e) {
                showToast(e.message, 'error', 'Error al cargar');
            }
        }

        function cargarFiltroAreas() {
            const areas = [...new Set(datosOriginales.map(o => o.area_siglas))];
            const select = document.getElementById('filterArea');
            select.innerHTML = '<option value="">Todas las 츼reas</option>';
            areas.forEach(area => {
                select.innerHTML += `<option value="${area}">${area}</option>`;
            });
        }

        function filtrarDatos() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const area = document.getElementById('filterArea').value;
            const etapa = document.getElementById('filterEtapa').value;

            datosFiltrados = datosOriginales.filter(o => {
                const matchSearch = !search || 
                    o.determinante.toLowerCase().includes(search) ||
                    o.asunto.toLowerCase().includes(search) ||
                    o.area_siglas.toLowerCase().includes(search);
                
                const matchArea = !area || o.area_siglas === area;
                const matchEtapa = !etapa || o.estado_workflow == etapa;

                return matchSearch && matchArea && matchEtapa;
            });

            renderizarTabla();
            actualizarIndicadores();
        }

        function renderizarTabla() {
            const tbody = document.getElementById('tablaOficios');
            tbody.innerHTML = '';

            datosFiltrados.forEach(oficio => {
                const etapa = getEtapaInfo(oficio.estado_workflow);
                const numDocs = (oficio.documentos || []).length;
                const hasDrive = oficio.drive_synced ? '<i class="fab fa-google-drive text-blue-600"></i>' : '-';
                
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition cursor-pointer" onclick="abrirModal(${JSON.stringify(oficio).replace(/"/g, '&quot;')})">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">${oficio.determinante}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-semibold rounded-full ${getColorArea(oficio.area_siglas)}">
                                ${oficio.area_siglas}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-3 py-1 text-xs font-semibold rounded-full ${etapa.color}">
                                ${etapa.nombre}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            ${getEstadoBadge(oficio)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="flex items-center gap-2">
                                <i class="fas fa-paperclip text-gray-500"></i>
                                <span class="text-sm font-medium">${numDocs}</span>
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            ${hasDrive}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            ${formatDate(oficio.fecha)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <button onclick="event.stopPropagation(); abrirModal(${JSON.stringify(oficio).replace(/"/g, '&quot;')})" 
                                    class="text-green-600 hover:text-green-900">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function actualizarIndicadores() {
            document.getElementById('totalOficios').textContent = datosFiltrados.length;
            document.getElementById('firmasPendientes').textContent = 
                datosFiltrados.filter(o => o.estado_workflow === 2).length;
            document.getElementById('notificacionesPendientes').textContent = 
                datosFiltrados.filter(o => o.estado_workflow === 3).length;
            document.getElementById('expedientesCompletados').textContent = 
                datosFiltrados.filter(o => o.estado_workflow === 4).length;
        }

        // ====================== MODAL ======================

        function abrirModal(oficio) {
            oficioActual = oficio;
            
            document.getElementById('modalDeterminante').textContent = oficio.determinante;
            document.getElementById('modalArea').textContent = oficio.area_siglas;
            document.getElementById('modalFecha').textContent = new Date(oficio.fecha).toLocaleDateString('es-MX');
            document.getElementById('modalAsunto').textContent = oficio.asunto || 'Sin asunto';
            
            renderizarTimeline();
            renderizarDocumentos();
            renderizarObservaciones();
            renderizarAuditoria();
            actualizarBotonesControl();
            
            if (oficio.drive_synced) {
                document.getElementById('driveInfo').classList.remove('hidden');
            } else {
                document.getElementById('driveInfo').classList.add('hidden');
            }
            
            document.getElementById('modalOficio').style.display = 'flex';
        }

        function cerrarModal() {
            document.getElementById('modalOficio').style.display = 'none';
            oficioActual = null;
            archivosPendientes = [];
            archivosPreview = [];
            document.getElementById('inputArchivos').value = '';
            document.getElementById('previsualizacion').classList.add('hidden');
        }

        function renderizarTimeline() {
            const container = document.getElementById('timelineEtapas');
            const etapaActual = oficioActual.estado_workflow || 1;
            const bloqueado = oficioActual.etapa_bloqueada || false;
            
            const etapas = [
                { num: 1, nombre: 'Etapa 1: Captura', descripcion: 'Informaci칩n capturada por el 치rea' },
                { num: 2, nombre: 'Etapa 2: Firma del Titular', descripcion: 'Esperando firma del titular' },
                { num: 3, nombre: 'Etapa 3: Notificaci칩n', descripcion: 'Proceso de notificaci칩n' },
                { num: 4, nombre: 'Etapa 4: Expediente', descripcion: 'Integraci칩n en expediente' }
            ];

            let html = '';
            etapas.forEach((etapa, index) => {
                const isActive = etapa.num === etapaActual;
                const isCompleted = etapa.num < etapaActual;
                const isPending = etapa.num > etapaActual;
                const isBlocked = isActive && bloqueado;
                
                let estado = 'pending';
                if (isBlocked) estado = 'blocked';
                else if (isActive) estado = 'active';
                else if (isCompleted) estado = 'completed';
                
                html += `
                    <div class="timeline-item ${estado}">
                        ${index < etapas.length - 1 ? '<div class="timeline-line"></div>' : ''}
                        <div class="timeline-dot">
                            ${isBlocked ? '<i class="fas fa-lock"></i>' : 
                              isCompleted ? '<i class="fas fa-check"></i>' : 
                              isActive ? etapa.num : etapa.num}
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <h4 class="font-bold text-gray-900">${etapa.nombre}</h4>
                                ${isActive ? '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded">ACTIVA</span>' : ''}
                                ${isBlocked ? '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded">BLOQUEADA</span>' : ''}
                                ${isCompleted ? '<span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded">COMPLETADA</span>' : ''}
                            </div>
                            <p class="text-sm text-gray-600">${etapa.descripcion}</p>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function actualizarBotonesControl() {
            const etapaActual = oficioActual.estado_workflow || 1;
            const bloqueado = oficioActual.etapa_bloqueada || false;
            
            const btnAvanzar = document.getElementById('btnAvanzarEtapa');
            const btnRetroceder = document.getElementById('btnRetrocederEtapa');
            const btnBloquear = document.getElementById('btnBloquearEtapa');
            const textBloqueo = document.getElementById('textBloqueo');
            
            // Avanzar: habilitado si no est치 bloqueado y no es la 칰ltima etapa
            btnAvanzar.disabled = bloqueado || etapaActual >= 4;
            
            // Retroceder: habilitado si no est치 bloqueado y no es la primera etapa
            btnRetroceder.disabled = bloqueado || etapaActual <= 1;
            
            // Bloquear: siempre habilitado
            btnBloquear.disabled = false;
            textBloqueo.textContent = bloqueado ? 'Desbloquear Etapa' : 'Bloquear Etapa';
            
            if (bloqueado) {
                btnBloquear.classList.remove('bg-red-600', 'hover:bg-red-700');
                btnBloquear.classList.add('bg-yellow-600', 'hover:bg-yellow-700');
            } else {
                btnBloquear.classList.remove('bg-yellow-600', 'hover:bg-yellow-700');
                btnBloquear.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }

        // ====================== CONTROL DE ETAPAS ======================

        async function avanzarEtapa() {
            if (!oficioActual) return;
            
            const etapaActual = oficioActual.estado_workflow || 1;
            
            if (etapaActual >= 4) {
                showToast('Ya se encuentra en la 칰ltima etapa', 'warning', 'No disponible');
                return;
            }
            
            if (oficioActual.etapa_bloqueada) {
                showToast('La etapa est치 bloqueada. Desbloqu칠ala primero', 'warning', 'Etapa bloqueada');
                return;
            }
            
            const nuevaEtapa = etapaActual + 1;
            const confirmacion = confirm(`쮸vanzar a ${getEtapaInfo(nuevaEtapa).nombre}?`);
            
            if (!confirmacion) return;
            
            try {
                showToast('Avanzando etapa...', 'info', 'Procesando', 0);
                
                // Actualizar etapa
                const { error } = await db
                    .from('registro_oficios')
                    .update({ estado_workflow: nuevaEtapa })
                    .eq('id', oficioActual.id);
                
                if (error) throw error;
                
                // Registrar en historial
                await registrarCambioEtapa(etapaActual, nuevaEtapa, 'avance');
                await registrarAuditoria('cambio_etapa', `Avanz칩 de Etapa ${etapaActual} a Etapa ${nuevaEtapa}`);
                
                document.getElementById('toastContainer').innerHTML = '';
                showToast(`Avanzado a ${getEtapaInfo(nuevaEtapa).nombre}`, 'success', 'Etapa actualizada');
                
                oficioActual.estado_workflow = nuevaEtapa;
                renderizarTimeline();
                actualizarBotonesControl();
                cargarDatos();
                
            } catch (e) {
                document.getElementById('toastContainer').innerHTML = '';
                showToast(e.message, 'error', 'Error');
            }
        }

        async function retrocederEtapa() {
            if (!oficioActual) return;
            
            const etapaActual = oficioActual.estado_workflow || 1;
            
            if (etapaActual <= 1) {
                showToast('Ya se encuentra en la primera etapa', 'warning', 'No disponible');
                return;
            }
            
            if (oficioActual.etapa_bloqueada) {
                showToast('La etapa est치 bloqueada. Desbloqu칠ala primero', 'warning', 'Etapa bloqueada');
                return;
            }
            
            const nuevaEtapa = etapaActual - 1;
            const motivo = prompt(`쯄otivo para retroceder a ${getEtapaInfo(nuevaEtapa).nombre}?`);
            
            if (!motivo || motivo.trim() === '') {
                showToast('Debes proporcionar un motivo', 'warning', 'Motivo requerido');
                return;
            }
            
            try {
                showToast('Retrocediendo etapa...', 'info', 'Procesando', 0);
                
                const { error } = await db
                    .from('registro_oficios')
                    .update({ estado_workflow: nuevaEtapa })
                    .eq('id', oficioActual.id);
                
                if (error) throw error;
                
                await registrarCambioEtapa(etapaActual, nuevaEtapa, 'retroceso', motivo);
                await registrarAuditoria('retroceso_etapa', `Retrocedi칩 de Etapa ${etapaActual} a Etapa ${nuevaEtapa}. Motivo: ${motivo}`);
                
                document.getElementById('toastContainer').innerHTML = '';
                showToast(`Retrocedido a ${getEtapaInfo(nuevaEtapa).nombre}`, 'success', 'Etapa actualizada');
                
                oficioActual.estado_workflow = nuevaEtapa;
                renderizarTimeline();
                actualizarBotonesControl();
                cargarDatos();
                
            } catch (e) {
                document.getElementById('toastContainer').innerHTML = '';
                showToast(e.message, 'error', 'Error');
            }
        }

        async function toggleBloqueoEtapa() {
            if (!oficioActual) return;
            
            const bloqueado = !oficioActual.etapa_bloqueada;
            const accion = bloqueado ? 'bloquear' : 'desbloquear';
            const motivo = prompt(`쯄otivo para ${accion} la etapa actual?`);
            
            if (!motivo || motivo.trim() === '') {
                showToast('Debes proporcionar un motivo', 'warning', 'Motivo requerido');
                return;
            }
            
            try {
                showToast(`${bloqueado ? 'Bloqueando' : 'Desbloqueando'} etapa...`, 'info', 'Procesando', 0);
                
                const { error } = await db
                    .from('registro_oficios')
                    .update({ etapa_bloqueada: bloqueado })
                    .eq('id', oficioActual.id);
                
                if (error) throw error;
                
                await registrarAuditoria(
                    bloqueado ? 'bloqueo_etapa' : 'desbloqueo_etapa',
                    `${bloqueado ? 'Bloque칩' : 'Desbloque칩'} la Etapa ${oficioActual.estado_workflow}. Motivo: ${motivo}`
                );
                
                document.getElementById('toastContainer').innerHTML = '';
                showToast(`Etapa ${bloqueado ? 'bloqueada' : 'desbloqueada'} exitosamente`, 'success', 'Actualizado');
                
                oficioActual.etapa_bloqueada = bloqueado;
                renderizarTimeline();
                actualizarBotonesControl();
                cargarDatos();
                
            } catch (e) {
                document.getElementById('toastContainer').innerHTML = '';
                showToast(e.message, 'error', 'Error');
            }
        }

        async function registrarCambioEtapa(etapaAnterior, etapaNueva, tipo, motivo = '') {
            try {
                const historial = oficioActual.historial_etapas || [];
                historial.push({
                    fecha: new Date().toISOString(),
                    etapa_anterior: etapaAnterior,
                    etapa_nueva: etapaNueva,
                    tipo: tipo,
                    motivo: motivo,
                    usuario: 'Sistema' // Aqu칤 puedes poner el usuario actual si tienes auth
                });
                
                await db.from('registro_oficios')
                    .update({ historial_etapas: historial })
                    .eq('id', oficioActual.id);
                
                oficioActual.historial_etapas = historial;
            } catch (e) {
                console.error('Error registrando cambio:', e);
            }
        }

        function mostrarHistorialEtapas() {
            const historial = oficioActual.historial_etapas || [];
            
            if (historial.length === 0) {
                showToast('No hay historial de cambios de etapa', 'info', 'Sin historial');
                return;
            }
            
            let html = '';
            historial.reverse().forEach(cambio => {
                const fecha = new Date(cambio.fecha).toLocaleString('es-MX');
                const icono = cambio.tipo === 'avance' ? 'arrow-right' : 'arrow-left';
                const color = cambio.tipo === 'avance' ? 'text-green-600' : 'text-orange-600';
                
                html += `
                    <div class="history-item">
                        <div class="flex items-start gap-3">
                            <i class="fas fa-${icono} ${color} mt-1"></i>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-semibold text-gray-900">
                                        ${getEtapaInfo(cambio.etapa_anterior).nombre}  ${getEtapaInfo(cambio.etapa_nueva).nombre}
                                    </span>
                                    <span class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">${cambio.tipo}</span>
                                </div>
                                <p class="text-sm text-gray-600 mb-1">${cambio.motivo || 'Sin motivo especificado'}</p>
                                <p class="text-xs text-gray-500">
                                    <i class="far fa-clock mr-1"></i>${fecha}
                                    ${cambio.usuario ? `  ${cambio.usuario}` : ''}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('contenidoHistorial').innerHTML = html;
            document.getElementById('modalHistorial').style.display = 'flex';
        }

        function cerrarModalHistorial() {
            document.getElementById('modalHistorial').style.display = 'none';
        }

        // ====================== DOCUMENTOS ======================

        function renderizarDocumentos() {
            const container = document.getElementById('listaDocumentos');
            const docs = oficioActual.documentos || [];
            
            if (docs.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300">
                        <i class="fas fa-inbox text-gray-400 text-4xl mb-3"></i>
                        <p class="text-gray-500">No hay documentos adjuntos</p>
                        <p class="text-sm text-gray-400">Utiliza el formulario superior para cargar documentos</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">';
            docs.forEach((doc, index) => {
                const isPDF = doc.tipo === 'application/pdf';
                const hasDrive = doc.drive_file_id ? '<i class="fab fa-google-drive text-blue-600 ml-2"></i>' : '';
                
                html += `
                    <div class="preview-item group">
                        ${isPDF ? 
                            `<div class="preview-pdf">
                                <i class="fas fa-file-pdf text-red-500 text-6xl"></i>
                            </div>` :
                            `<img src="${doc.contenido}" alt="${doc.nombre}" class="preview-image">`
                        }
                        <div class="p-3">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate" title="${doc.nombre}">
                                        ${doc.nombre}${hasDrive}
                                    </p>
                                    <p class="text-xs text-gray-500">${formatBytes(doc.tama침o)}</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="verDocumento(${index})" 
                                        class="flex-1 bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700 transition">
                                    <i class="fas fa-eye mr-1"></i>Ver
                                </button>
                                <button onclick="descargarDoc(${index})" 
                                        class="flex-1 bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 transition">
                                    <i class="fas fa-download mr-1"></i>Descargar
                                </button>
                                <button onclick="eliminarDocumento(${index})" 
                                        class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700 transition">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            if (docs.length > 1) {
                html += `
                    <div class="mt-4 flex justify-between items-center">
                        <button onclick="verDocumentos(oficioActual.documentos)" 
                                class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                            <i class="fas fa-images mr-1"></i>Ver todos en galer칤a
                        </button>
                        <button onclick="eliminarTodosDocumentos()" 
                                class="text-red-600 hover:text-red-800 text-sm font-medium">
                            <i class="fas fa-trash-alt mr-1"></i>Eliminar todos (${docs.length})
                        </button>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        function previsualizarArchivos() {
            const input = document.getElementById('inputArchivos');
            const files = Array.from(input.files);
            
            if (files.length === 0) {
                document.getElementById('previsualizacion').classList.add('hidden');
                archivosPendientes = [];
                archivosPreview = [];
                return;
            }
            
            archivosPendientes = files;
            archivosPreview = [];
            
            const container = document.getElementById('listaPreview');
            container.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    archivosPreview.push({
                        nombre: file.name,
                        tipo: file.type,
                        tama침o: file.size,
                        contenido: e.target.result
                    });
                    
                    const isPDF = file.type === 'application/pdf';
                    const div = document.createElement('div');
                    div.className = 'preview-item';
                    div.innerHTML = `
                        ${isPDF ? 
                            `<div class="preview-pdf">
                                <i class="fas fa-file-pdf text-red-500 text-4xl"></i>
                            </div>` :
                            `<img src="${e.target.result}" alt="${file.name}" class="preview-image">`
                        }
                        <div class="p-2">
                            <p class="text-xs font-medium text-gray-900 truncate" title="${file.name}">${file.name}</p>
                            <p class="text-xs text-gray-500">${formatBytes(file.size)}</p>
                        </div>
                        <button onclick="eliminarPreview(${index})" class="remove-preview">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    container.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
            
            document.getElementById('previsualizacion').classList.remove('hidden');
        }

        function eliminarPreview(index) {
            archivosPendientes.splice(index, 1);
            archivosPreview.splice(index, 1);
            
            const dt = new DataTransfer();
            archivosPendientes.forEach(file => dt.items.add(file));
            document.getElementById('inputArchivos').files = dt.files;
            
            previsualizarArchivos();
        }

        async function subirDocumentos() {
            if (!oficioActual) return;
            
            if (archivosPreview.length === 0) {
                showToast('No hay archivos para subir', 'warning', 'Sin archivos');
                return;
            }
            
            try {
                showToast(`Subiendo ${archivosPreview.length} documento(s)...`, 'info', 'Procesando', 0);
                
                const documentosActuales = oficioActual.documentos || [];
                const documentosNuevos = [...documentosActuales, ...archivosPreview];
                
                const { error } = await db
                    .from('registro_oficios')
                    .update({ documentos: documentosNuevos })
                    .eq('id', oficioActual.id);
                
                if (error) throw error;
                
                oficioActual.documentos = documentosNuevos;
                
                document.getElementById('toastContainer').innerHTML = '';
                showToast(`${archivosPreview.length} documento(s) subidos exitosamente`, 'success', 'Completado');
                
                await registrarAuditoria('subir_documentos', `Subi칩 ${archivosPreview.length} documento(s)`);
                
                archivosPendientes = [];
                archivosPreview = [];
                document.getElementById('inputArchivos').value = '';
                document.getElementById('previsualizacion').classList.add('hidden');
                
                renderizarDocumentos();
                cargarDatos();
                
            } catch (e) {
                document.getElementById('toastContainer').innerHTML = '';
                showToast(e.message, 'error', 'Error al subir');
            }
        }

        async function eliminarDocumento(index) {
            const doc = oficioActual.documentos[index];
            
            if (!confirm(`쮼liminar el documento "${doc.nombre}"?\n\nEsta acci칩n no se puede deshacer.`)) {
                return;
            }
            
            try {
                showToast('Eliminando documento...', 'info', 'Procesando', 0);
                
                const documentosActualizados = oficioActual.documentos.filter((_, i) => i !== index);
                
                const { error } = await db
                    .from('registro_oficios')
                    .update({ documentos: documentosActualizados })
                    .eq('id', oficioActual.id);
                
                if (error) throw error;
                
                oficioActual.documentos = documentosActualizados;
                
                document.getElementById('toastContainer').innerHTML = '';
                showToast(`Documento "${doc.nombre}" eliminado`, 'success', 'Eliminado');
                
                await registrarAuditoria('eliminar_documento', `Elimin칩 el documento "${doc.nombre}"`);
                
                renderizarDocumentos();
                cargarDatos();
                
            } catch (e) {
                document.getElementById('toastContainer').innerHTML = '';
                showToast(e.message, 'error', 'Error al eliminar');
            }
        }

        async function eliminarTodosDocumentos() {
            const total = oficioActual.documentos.length;
            
            if (!confirm(`丘멆잺 쮼LIMINAR TODOS LOS DOCUMENTOS?\n\nSe eliminar치n ${total} documento(s).\n\nEsta acci칩n NO se puede deshacer.`)) {
                return;
            }
            
            if (!confirm(`游뚿 CONFIRMA NUEVAMENTE\n\nRealmente deseas eliminar los ${total} documentos?\n\n칔ltima oportunidad para cancelar.`)) {
                return;
            }
            
            try {
                showToast(`Eliminando ${total} documento(s)...`, 'info', 'Procesando', 0);
                
                const { error } = await db
                    .from('registro_oficios')
                    .update({ documentos: [] })
                    .eq('id', oficioActual.id);
                
                if (error) throw error;
                
                oficioActual.documentos = [];
                
                document.getElementById('toastContainer').innerHTML = '';
                showToast(`${total} documento(s) eliminados`, 'success', 'Completado');
                
                await registrarAuditoria('eliminar_todos_documentos', `Elimin칩 todos los documentos (${total})`);
                
                renderizarDocumentos();
                cargarDatos();
                
            } catch (e) {
                document.getElementById('toastContainer').innerHTML = '';
                showToast(e.message, 'error', 'Error al eliminar');
            }
        }

        // ====================== VISOR DE DOCUMENTOS ======================

        function verDocumentos(docs) {
            if (!docs || docs.length === 0) return;
            allDocsForViewer = docs;
            currentDocIndex = 0;
            mostrarDocumentoEnVisor(0);
        }

        function verDocumento(index) {
            allDocsForViewer = oficioActual.documentos;
            currentDocIndex = index;
            mostrarDocumentoEnVisor(index);
        }

        function mostrarDocumentoEnVisor(index) {
            const doc = allDocsForViewer[index];
            const viewer = document.getElementById('docViewer');
            const img = document.getElementById('viewerImage');
            const pdf = document.getElementById('viewerPDF');
            const counter = document.getElementById('viewerCounter');
            
            currentDocIndex = index;
            counter.textContent = `${index + 1} / ${allDocsForViewer.length}`;
            
            if (doc.tipo === 'application/pdf') {
                img.classList.add('hidden');
                pdf.classList.remove('hidden');
                pdf.src = doc.contenido;
            } else {
                pdf.classList.add('hidden');
                img.classList.remove('hidden');
                img.src = doc.contenido;
            }
            
            resetZoom();
            viewer.classList.remove('hidden');
        }

        function cerrarVisor() {
            document.getElementById('docViewer').classList.add('hidden');
            allDocsForViewer = [];
            currentDocIndex = 0;
        }

        function navegarDoc(direccion) {
            let nuevoIndex = currentDocIndex + direccion;
            if (nuevoIndex < 0) nuevoIndex = allDocsForViewer.length - 1;
            if (nuevoIndex >= allDocsForViewer.length) nuevoIndex = 0;
            mostrarDocumentoEnVisor(nuevoIndex);
        }

        function zoomDoc(delta) {
            currentZoom += delta;
            if (currentZoom < 0.5) currentZoom = 0.5;
            if (currentZoom > 3) currentZoom = 3;
            document.getElementById('viewerImage').style.transform = `scale(${currentZoom})`;
        }

        function resetZoom() {
            currentZoom = 1;
            document.getElementById('viewerImage').style.transform = 'scale(1)';
        }

        function descargarDocActual() {
            descargarDoc(currentDocIndex);
        }

        function descargarDoc(index) {
            const doc = allDocsForViewer.length > 0 ? allDocsForViewer[index] : oficioActual.documentos[index];
            const link = document.createElement('a');
            link.href = doc.contenido;
            link.download = doc.nombre;
            link.click();
        }

        // ====================== OBSERVACIONES ======================

        function renderizarObservaciones() {
            const container = document.getElementById('listaObservaciones');
            const observaciones = oficioActual.observaciones || [];
            
            if (observaciones.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 bg-gray-50 rounded-lg border border-gray-200">
                        <i class="fas fa-comment-slash text-gray-400 text-2xl mb-2"></i>
                        <p class="text-sm text-gray-500">No hay observaciones registradas</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            observaciones.reverse().forEach((obs, index) => {
                const fecha = new Date(obs.fecha).toLocaleString('es-MX');
                html += `
                    <div class="bg-purple-50 border border-purple-200 rounded-lg p-4">
                        <div class="flex items-start justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <i class="fas fa-user-circle text-purple-600"></i>
                                <span class="font-semibold text-gray-900">${obs.usuario || 'Sistema'}</span>
                            </div>
                            <span class="text-xs text-gray-500">${fecha}</span>
                        </div>
                        <p class="text-gray-700">${obs.texto}</p>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function agregarObservacion() {
            const textarea = document.getElementById('nuevaObservacion');
            const texto = textarea.value.trim();
            
            if (!texto) {
                showToast('Escribe una observaci칩n primero', 'warning', 'Campo vac칤o');
                return;
            }
            
            try {
                const observaciones = oficioActual.observaciones || [];
                observaciones.push({
                    fecha: new Date().toISOString(),
                    texto: texto,
                    usuario: 'Sistema' // Aqu칤 puedes poner el usuario actual
                });
                
                const { error } = await db
                    .from('registro_oficios')
                    .update({ observaciones: observaciones })
                    .eq('id', oficioActual.id);
                
                if (error) throw error;
                
                oficioActual.observaciones = observaciones;
                textarea.value = '';
                
                showToast('Observaci칩n agregada', 'success', 'Guardado');
                await registrarAuditoria('agregar_observacion', `Agreg칩 una observaci칩n`);
                
                renderizarObservaciones();
                
            } catch (e) {
                showToast(e.message, 'error', 'Error');
            }
        }

        // ====================== AUDITOR칈A ======================

        function renderizarAuditoria() {
            const container = document.getElementById('listaAuditoria');
            const auditoria = oficioActual.auditoria || [];
            
            if (auditoria.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4 bg-gray-50 rounded-lg border border-gray-200">
                        <i class="fas fa-clipboard-list text-gray-400 text-2xl mb-2"></i>
                        <p class="text-sm text-gray-500">No hay registros de auditor칤a</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            auditoria.reverse().slice(0, 20).forEach(registro => {
                const fecha = new Date(registro.fecha).toLocaleString('es-MX');
                const icono = getIconoAccion(registro.accion);
                
                html += `
                    <div class="flex items-start gap-3 p-2 hover:bg-gray-50 rounded transition">
                        <i class="fas fa-${icono} text-indigo-600 mt-1"></i>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm text-gray-900">${registro.descripcion}</p>
                            <p class="text-xs text-gray-500">${fecha}</p>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        async function registrarAuditoria(accion, descripcion) {
            try {
                const auditoria = oficioActual.auditoria || [];
                auditoria.push({
                    fecha: new Date().toISOString(),
                    accion: accion,
                    descripcion: descripcion,
                    usuario: 'Sistema'
                });
                
                await db.from('registro_oficios')
                    .update({ auditoria: auditoria })
                    .eq('id', oficioActual.id);
                
                oficioActual.auditoria = auditoria;
            } catch (e) {
                console.error('Error en auditor칤a:', e);
            }
        }

        function getIconoAccion(accion) {
            const iconos = {
                'cambio_etapa': 'exchange-alt',
                'retroceso_etapa': 'undo',
                'bloqueo_etapa': 'lock',
                'desbloqueo_etapa': 'unlock',
                'subir_documentos': 'upload',
                'eliminar_documento': 'trash',
                'eliminar_todos_documentos': 'trash-alt',
                'agregar_observacion': 'comment',
                'drive_backup': 'cloud-upload-alt'
            };
            return iconos[accion] || 'circle';
        }

        // ====================== UTILIDADES ======================

        function getEtapaInfo(etapa) {
            const etapas = {
                1: { nombre: 'Etapa 1: Captura', color: 'bg-gray-100 text-gray-800' },
                2: { nombre: 'Etapa 2: Firma', color: 'bg-orange-100 text-orange-800' },
                3: { nombre: 'Etapa 3: Notificaci칩n', color: 'bg-purple-100 text-purple-800' },
                4: { nombre: 'Etapa 4: Expediente', color: 'bg-green-100 text-green-800' }
            };
            return etapas[etapa] || etapas[1];
        }

        function getEstadoBadge(oficio) {
            if (oficio.etapa_bloqueada) {
                return '<span class="px-2 py-1 bg-red-100 text-red-800 text-xs font-semibold rounded-full flex items-center gap-1"><i class="fas fa-lock"></i>Bloqueada</span>';
            }
            return '<span class="px-2 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full flex items-center gap-1"><i class="fas fa-check"></i>Activa</span>';
        }

        function getColorArea(area) {
            const colores = [
                'bg-blue-100 text-blue-800',
                'bg-green-100 text-green-800',
                'bg-purple-100 text-purple-800',
                'bg-pink-100 text-pink-800',
                'bg-yellow-100 text-yellow-800',
                'bg-indigo-100 text-indigo-800',
                'bg-red-100 text-red-800',
                'bg-teal-100 text-teal-800'
            ];
            const index = area.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) % colores.length;
            return colores[index];
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (minutes < 1) return 'Justo ahora';
            if (minutes < 60) return `Hace ${minutes} min`;
            if (hours < 24) return `Hace ${hours} hora${hours > 1 ? 's' : ''}`;
            if (days < 7) return `Hace ${days} d칤a${days > 1 ? 's' : ''}`;
            
            return date.toLocaleDateString('es-MX', { 
                day: '2-digit', 
                month: 'short',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            });
        }

        function exportarExcel() {
            const dataExcel = datosFiltrados.map(r => ({
                'Determinante': r.determinante,
                '츼rea': r.area_siglas,
                'Etapa': r.estado_workflow,
                'Estado': r.etapa_bloqueada ? 'Bloqueada' : 'Activa',
                'Documentos': (r.documentos || []).length,
                'Drive': r.drive_synced ? 'S칤' : 'No',
                'Fecha': new Date(r.fecha).toLocaleDateString('es-MX'),
                'Asunto': r.asunto
            }));
            
            const ws = XLSX.utils.json_to_sheet(dataExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Determinantes OR-130');
            XLSX.writeFile(wb, `OR130_${new Date().toISOString().split('T')[0]}.xlsx`);
        }

        // ====================== SISTEMA DE NOTIFICACIONES ======================

        function showToast(message, type = 'info', title = '', duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const icons = {
                success: '九',
                error: '九',
                warning: '丘',
                info: ''
            };
            
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#3b82f6'
            };
            
            toast.innerHTML = `
                <div class="toast-icon" style="color: ${colors[type]}">${icons[type]}</div>
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
                <div class="toast-close" onclick="this.parentElement.remove()">九</div>
            `;
            
            container.appendChild(toast);
            
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.add('removing');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
        }
    </script>
</body>
</html>
